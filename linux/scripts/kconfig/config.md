Kernel Config
=============

## Flow

- config
  - `make alldefconfig` to generate config
    - or `make defconfig` to use arch defaults, which include common device
      drivers for the arch
    - or download a pre-made config and `make olddefconfig`
      - such as
        <https://raw.githubusercontent.com/raspberrypi/linux/rpi-6.1.y/arch/arm64/configs/bcm2711_defconfig>
  - `make menuconfig` to edit generated config
    - to discover non-discoverable devices,
      - `dtc -I fs /sys/firmware/devicetree/base` and look for `compatible`
        property.  Kernel uses the property to bind drivers.
      - `find /sys/devices/LNXSYSTM:00 -name modalias`.  Kernel uses modalias
        to bind drivers.  (It is constructed from `_HID` and `_CID` of the
        ACPI devices btw)
    - to discover discoverable devices,
      - lspci
      - lsusb
- build
  - `make` to build kernel image, modules, and dtbs
- install
  - `make install` to invoke `installkernel`
  - `make modules_install` to install to `INSTALL_MOD_PATH`
- cross compile
  - get cross compiler
    - `crossbuild-essential-arm64` on Debian-like
    - `aarch64-linux-gnu-gcc` on Arch-like
  - set variables
    - `ARCH=arm64`
    - `CROSS_COMPILE=aarch64-linux-gnu-`
  - manual install
    - copy `arch/arm64/boot/Image` for ARM64
- post install (Arch)
  - initramfs
    - `mkinitcpio -k $version -g /boot/initramfs.img`
  - systemd-boot
    - `/boot/loader/entries/custom.conf`
      - `title Custom Linux`
      - `linux /vmlinuz`
      - `initrd /initramfs.img`
      - `options root=/dev/sda2 rw`
  - out-of-tree drivers
    - `pacman -S broadcom-wl-dkms`
    - `dkms autoinstall`
- post install (Raspberry Pi)
  - copy `arch/arm64/boot/Image` and
    `arch/arm64/boot/dts/broadcom/bcm2711-rpi-4-b.dtb`
  - `config.txt`
    - `arm_64bit=1`
    - `kernel=Image`

## Tips

- Unable to boot?
  - must built-in for initramfs to work
    - script (#!) support for init scripts
    - devtmpfs and unix socket support for udev
  - to debug
    - Built-in EFI or Simple framebuffer to see console
    - Built-in keyboard driver to interact
    - Built-in scsi/ata/fs drivers to mount
- No `/dev/dri`?
  - `echo 0x1ff > /sys/module/drm/parameters/debug`
  - `[drm:vc5_hdmi_init_resources [vc4]] ERROR Failed to get HDMI state machine clock`
    - make sure `vc4` is loaded after `raspberrypi-clk`
  - `[drm:vc4_hdmi_bind [vc4]] Failed to get ddc i2c adapter by node`
    - make sure `vc4` is loaded after `i2c-brcmstb`

## Config: Common

- select `General setup`
  - select `System V IPC`
  - select `POSIX Message Queues`, depending on `NET`
  - select `Timers subsystem`
    - select `Timer tick handling (Idle dynticks system (tickless idle))`
    - select `High Resolution Timer Support`
  - select `BPF subsystem`
    - select `Enable bpf() system call`
    - select `Enable BPF Just In Time compiler`, depending on `MODULES`
      - select `Permanently enable BPF JIT and remove BPF interpreter`
  - select `Preemption Model (Voluntary Kernel Preemption (Desktop))`
  - select `CPU/Task time and stats accounting`
    - select `Export task/process statistics through netlink`
      - select `Enable per-task delay accounting`
      - select `Enable extended accounting over taskstats`
        - select `Enable per-task storage I/O accounting`
    - select `Pressure stall information tracking`
  - select `Kernel .config support`
    - select `Enable access to .config through /proc/config.gz`
  - select `Control Group support`
  - select `Namespaces support`
    - select `User namespace`
  - select `Automatic process group scheduling`
  - select `Initial RAM filesystem and RAM disk (initramfs/initrd) support`
  - select `Kernel Performance Events And Counters`
    - select `Kernel performance events and counters`
- select `General architecture-dependent options`
  - select `Optimize very unlikely/likely branches`
  - select `Provide system calls for 32-bit time_t`
- select `Enable loadable module support`
  - select `Module unloading`
- select `Executable file formats`
  - select `Kernel support for MISC binaries`
- select `Memory Management options`
  - select `Transparent Hugepage Support`
    - select `Transparent Hugepage Support sysfs defaults (always)`
  - select `Multi-Gen LRU`
    - select `Enable by default`
- select `Networking support`
  - select `Networking options`
    - select `Packet socket`
    - select `Unix domain sockets`
    - select `TCP/IP networking`
    - select `Network packet filtering framework (Netfilter)` if desired
      - select `Core Netfilter Configuration`
        - select `Netfilter connection tracking support`
        - select `Network Address Translation support`
        - select `Netfilter nf_tables support`
          - select `Netfilter nf_tables masquerade support`
          - select `Netfilter nf_tables nat module`, depending on `NF_TABLES_IPV4`
      - select `IP: Netfilter Configuration`
        - select `IPv4 nf_tables support`
      - select `IPv6: Netfilter Configuration`
        - select `IPv6 nf_tables support`
    - select `802.1d Ethernet Bridging` if desired
    - select `802.1Q/802.1ad VLAN Support` if desired
    - select `Virtual Socket protocol` if kvm or guest
    - select `virtio transport for Virtual Sockets` if guest, depending on `PCI` and `VIRTIO_PCI`
  - select `Wireless` if needed
    - select `cfg80211 - wireless configuration API`
    - select `Generic IEEE 802.11 Networking Stack (mac80211)`
  - select `RF switch subsystem support`
- select `File systems`
  - select `The Extended 4 (ext4) filesystem`
    - select `Ext4 POSIX Access Control Lists`
  - select `Btrfs filesystem support` if desired
    - select `Btrfs POSIX Access Control Lists`
  - select `F2FS filesystem support` if desired
  - deselect `Dnotify support`
  - select `Filesystem wide access notification`
  - select `Kernel automounter support (supports v3, v4 and v5)` (for systemd)
  - select `FUSE (Filesystem in Userspace) support` if desired
  - select `Overlay filesystem support` if desired
  - select `DOS/FAT/NT Filesystems`
    - select `VFAT (Windows-95) fs support` if uefi
    - select `Enable FAT UTF-8 option by default` if uefi
    - select `exFAT filesystem support` if desired
  - select `Pseudo filesystems`
    - select `Tmpfs virtual memory file system support (former shm fs)`
      - select `Tmpfs POSIX Access Control Lists`
    - select `EFI Variable filesystem` if uefi, depending on `EFI`
  - select `Miscellaneous filesystems`
    - select `Persistent store support`
      - select `Log kernel console messages`
      - select `Log panic/oops to a RAM buffer`
  - select `Native language support` if uefi
    - select `Codepage 437 (United States, Canada)`
    - select `NLS ISO 8859-1  (Latin 1; Western European Languages)`
    - select `NLS UTF-8`
- select `Security options` if pacman
  - select `Enable different security models`
  - select `Landlock support`
- select `Cryptographic API` if iwd
  - select `Block ciphers`
    - select `AES (Advanced Encryption Standard)`
    - select `DES and Triple DES EDE`
  - select `Length-preserving ciphers and modes`
    - select `CBC (Cipher Block Chaining)`
    - select `ECB (Electronic Codebook)`
  - select `Hashes, digests, and MACs`
    - select `CMAC (Cipher-based MAC)`
    - select `HMAC (Keyed-Hash MAC)`
    - select `MD5`
    - select `SHA-1`
    - select `SHA-224 and SHA-256`
    - select `SHA-384 and SHA-512`
  - select `Userspace interface`
    - select `Hash algorithms`
    - select `Symmetric key cipher algorithms`
    - deselect `Obsolete cryptographic algorithms`
- select `Kernel hacking`
  - select `printk and dmesg options`
    - select `Show timing information on printks`
  - select `Kernel debugging`
  - select `Generic Kernel Debugging Instruments`
    - select `Magic SysRq key`
    - select `Debug Filesystem`
  - select `Tracers`
    - select `Kernel Function Tracer`
    - select `Trace syscalls`

## Config: x86

- select `Processor type and features`
  - select `Symmetric multi-processing support`
  - select `Support x2apic`, depending on `IRQ_REMAP`
  - deselect `Enable MPS table`
  - deselect `Support for extended (non-PC) x86 platforms`
  - select `Intel Low Power Subsystem Support` if intel, depending on `PCI`
  - select `AMD ACPI2Platform devices support` if amd
  - select `Linux guest support` if guest
    - select `Enable paravirtualization code`
  - select `Processor family (Core 2/newer Xeon)` if intel and desired
  - select `Processor family (Opteron/Athlon64/Hammer/K8)` if amd and desired
  - select `EFI runtime service support` if uefi
  - select `Timer frequency (1000 HZ)`
  - select `Built-in kernel command line` if desired
    - select `Built-in command line overrides boot loader arguments` if desired
- select `Mitigations for CPU vulnerabilities`
  - deselect `Mitigate speculative RAS overflow on AMD` if amd
- select `Power management and ACPI options`
  - select `Device power management core functionality`
    - select `Power Management Debug Support` if debug
  - select `ACPI (Advanced Configuration and Power Interface) Support`
    - select `ACPI Time and Alarm (TAD) Device Support` if desired
    - select `Processor Aggregator` if desired
  - select `CPU Frequency scaling`
    - select `CPU Frequency scaling`
      - select `AMD Processor P-State driver` if amd
        - select `AMD Processor P-State default mode` if cros
          - guybrush requires 2
      - select `ACPI Processor P-States driver` if amd
  - select `Cpuidle Driver for Intel Processors` if intel
- select `Binary Emulations`
  - select `IA32 Emulation`

## Config: arm64

- select `Platform selection`
  - select `Broadcom SoC Support` if rpi
    - select `Broadcom BCM2835 family`
  - select `MediaTek SoC Family` if mtk
  - select `Qualcomm Platforms` if qcom
  - select `Rockchip Platforms` if rk
- select `Kernel Features`
  - select `Multi-core scheduler support`
  - select `Timer frequency (1000 HZ)`
  - select `Kernel support for 32-bit EL0`
    - select `Emulate deprecated/obsolete ARMv8 instructions`
      - select all
  - select `ARMv8.2 architectural features`
    - select `Enable support for persistent memory`
  - select `Support for NMI-like interrupts`
- select `Boot options`
  - select `Default kernel command string` if desired
    - select `Kernel command line type (Always use the default kernel command string)` if desired
  - deselect `UEFI runtime support`
- select `Power management options`
  - select `Device power management core functionality`
    - select `Power Management Debug Support` if debug
  - select `Energy Model for devices with DVFS (CPUs, GPUs, etc)`, depending on `CPU_FREQ`
- select `CPU Power Management`
  - select `CPU Idle`
    - select `CPU idle PM support`
      - select `ARM CPU Idle Drivers`
        - select `PSCI CPU idle Driver`
  - select `CPU Frequency scaling`
    - select `CPU Frequency scaling`
      - select `Generic DT based cpufreq driver`
      - select `CPU Frequency scaling support for MediaTek SoCs` if mtk, depending on `REGULATOR`
      - select `MediaTek CPUFreq HW driver` if mtk
      - select `QCOM CPUFreq HW driver` if qcom
      - select `Raspberry Pi cpufreq support` if rpi, depending on `MAILBOX`, `BCM2835_MBOX`, `RASPBERRYPI_FIRMWARE` and `CLK_RASPBERRYPI`

## Config: Device Drivers

- select `Virtualization` if desired
  - select `Kernel-based Virtual Machine (KVM) support`
    - select `KVM for Intel processors support` if intel
    - select `KVM for AMD processors support` if amd
- select `Networking support`
  - select `Networking options` if qcom
    - select `Qualcomm IPC Router support`
      - select `SMD IPC Router channels`, depending on `HWSPINLOCK`, `MAILBOX`, `QCOM_SMEM`, and `RPMSG_QCOM_GLINK_SMEM`
      - select `TUN device for Qualcomm IPC Router`
  - select `Bluetooth subsystem support` if desired
    - select `Bluetooth device drivers`
      - select `HCI USB driver` if x86/mtk, depending on `USB`
        - select `MediaTek protocol support` if mtk
      - select `HCI UART driver` if qcom/rpi
        - select `Broadcom protocol support` if rpi, depending on `SERIAL_DEV_BUS`
        - select `Qualcomm Atheros protocol support` if qcom, depending on `SERIAL_DEV_BUS`
- select `Device Drivers`
  - select `PCI support` if pci
    - select `PCI Express Port Bus support`
      - select `PCI Express Advanced Error Reporting support`
    - select `Message Signaled Interrupts (MSI and MSI-X)`
    - select `Support for PCI Hotplug` if needed (for usb4)
    - select `PCI controller drivers` if arm
      - select `Broadcom Brcmstb PCIe host controller` if rpi
      - select `MediaTek Gen3 PCIe controller` if mtk
      - select `DesignWare-based PCIe controllers`
        - select `Qualcomm PCIe controller (host mode)` if newer qcom
        - select `Rockchip DesignWare PCIe controller (host mode)` if rk
  - select `Generic Driver Options`
    - select `Maintain a devtmpfs filesystem to mount at /dev` (for systemd)
      - select `Automount devtmpfs at /dev, after the kernel mounted the rootfs`
    - select `Firmware loader`
      - select `Firmware loading facility`
        - select `Build named firmware blobs into the kernel binary` if built-in i915/amdgpu/microcode/etc
        - select `Enable compressed firmware support`
  - select `Firmware Drivers`
    - select `Raspberry Pi Firmware Driver` if rpi
    - select `MTK ADSP IPC Protocol driver` if mtk, depending on `MTK_ADSP_MBOX`
    - select `Mark VGA/VBE/EFI FB as generic system framebuffer` if x86
    - select `Google Firmware Drivers` if cros
      - select `SMI interface for Google platforms` if x86
      - select `Coreboot Table Access`
      - select `Firmware Memory Console`
      - select `Vital Product Data`
  - select `Memory Technology Device (MTD) support`
    - select `SPI NOR device support`, depending on `SPI`
  - select `Block devices`
    - select `Compressed RAM block device support`, depending on `CRYPTO_LZO`
    - select `Loopback device support`
    - select `Virtio block driver` if guest, depending on `VIRTIO_PCI`
  - select `NVME Support` if needed
    - select `NVM Express block device`
  - select `Misc devices`
    - select `EEPROM support`
      - select `I2C EEPROMs / RAMs / ROMs from most vendors` if x86, depending on `I2C`
    - if intel,
      - select `Intel Management Engine Interface`
      - select `ME Enabled Intel Chipsets`
      - select `Intel MEI GSC embedded device`
      - select `Intel HDCP2.2 services of ME Interface` if protected, depending on `DRM_I915`
      - select `Intel PXP services of ME Interface` if protected, depending on `DRM_I915`
      - select `Intel GSC Proxy services of ME Interface`
    - select `Realtek PCI-E card reader` if needed
  - select `SCSI device support` if sata or usb mass storage
    - select `SCSI device support`
    - deselect `legacy /proc/scsi/ support`
    - select `SCSI disk support`
  - select `Serial ATA and Parallel ATA drivers (libata)` if needed
    - select `AHCI SATA support`
    - deselect `ATA SFF support (for legacy IDE and PATA)`
  - select `Multiple devices driver support (RAID and LVM)` if desired
    - select `Device mapper support`
  - select `Network device support`
    - select `Network core driver support`
      - select `WireGuard secure network tunnel` if desired
      - select `MAC-VLAN support` if container
      - select `Universal TUN/TAP device driver support` if kvm
      - select `Virtual ethernet pair device` if container
      - select `Virtio network driver` if guest, depending on `VIRTIO_PCI`
    - select `Ethernet driver support` if needed
      - deselect all but the desired drivers, such as
      - select `Broadcom devices` if rpi
        - select `Broadcom GENET internal MAC support`
      - select `Intel devices` if intel
        - select `Intel(R) Ethernet Controller I225-LM/I225-V support`
    - select `Qualcomm IPA support` if qcom modem, depending on `REMOTEPROC`, `QCOM_SYSMON`, `QCOM_WCNSS_PIL`, `RPMSG_QCOM_SMD`, `QCOM_AOSS_QMP`, and `INTERCONNECT`
    - select `USB Network Adapters`, depending on `USB`
      - select `Realtek RTL8152/RTL8153 Based USB Ethernet Adapters`
    - select `Wireless LAN` if needed
      - deselect all but the desired drivers, such as
      - select `Atheros/Qualcomm devices` if qcom
        - select `Atheros 802.11ac wireless cards support`
        - select `Qualcomm ath10k SNOC support`
        - select `Qualcomm Technologies 802.11ax chipset support`, depending on `CRYPTO_MICHAEL_MIC`
          - select `Atheros ath11k AHB support`, depending on `REMOTEPROC`
      - select `Broadcom devices` if rpi
        - select `Broadcom FullMAC WLAN driver`
      - select `Intel devices` if intel
        - select `Intel Wireless WiFi Next Gen AGN - Wireless-N/Advanced-N/Ultimate-N (iwlwifi)`
          - select `Intel Wireless WiFi MVM Firmware support`
      - select `MediaTek devices` if mtk
        - select `MediaTek MT7921E (PCIe) support`
  - select `Input device support`
    - select `Generic input layer (needed for keyboard, mouse, ...)`
      - select `Event interface`
      - select `Keyboards`
        - select `ChromeOS EC keyboard` if cros, depending on `CROS_EC`
      - select `Mice`
        - select `ELAN I2C Touchpad support` if needed, depending on `I2C`
      - select `Touchscreens`
        - select `Elan eKTH I2C touchscreen` if needed, depending on `I2C`
      - select `Miscellaneous devices`
        - select `PC Speaker support` if desired
        - select `Windows-compatible SoC Button Array` if desired, depending on `KEYBOARD_GPIO`
  - select `Character devices`
    - select `Enable TTY`
      - deselect `Legacy (BSD) PTY support`
      - deselect `Allow legacy TIOCSTI usage`
      - select `Serial drivers`
        - select `8250/16550 and compatible serial support` if x86/mtk
          - select `Console on 8250/16550 and compatible serial port`
        - select `Support for Synopsys DesignWare 8250 quirks` if x86
        - select `Mediatek serial port support` if mtk
        - select `QCOM on-chip GENI based serial port support` if qcom, depending on `QCOM_GENI_SE`
          - select `QCOM GENI Serial Console support`
    - select `Virtio console` if guest
    - select `Hardware Random Number Generator Core support`
      - deselect all but desired drivers
    - select `/dev/nvram support` if desired
    - select `TPM Hardware Support`
      - select `TPM Interface Specification 1.2 Interface / TPM 2.0 FIFO Interface` if needed
      - select `TPM Interface Specification 1.3 Interface / TPM 2.0 FIFO Interface - (SPI)` if needed, depending on `SPI`
        - select `Cr50 SPI Interface` if cros
      - select `TPM Interface Specification 2.0 Interface (I2C - CR50)` if cros, depending on `I2C`
      - select `TPM 2.0 CRB Interface` if needed
  - select `I2C support`
    - select `I2C support`
      - select `I2C Hardware Bus support`
        - select `Intel 82801 (ICH/PCH)` if intel
        - select `Intel PIIX4 and compatible (ATI/AMD/Serverworks/Broadcom/SMSC)` if x86
        - select `Broadcom BCM2835 I2C controller` if rpi
        - select `Synopsys DesignWare Platform` if x86, depending on `COMMON_CLK`
          - select `AMD PSP I2C semaphore support` if amd
        - select `MediaTek I2C adapter` if mtk
        - select `Qualcomm Technologies Inc.'s GENI based I2C controller` if qcom, depending on `QCOM_GENI_SE`
        - select `Rockchip RK3xxx I2C adapter` if rk
        - select `ChromeOS EC tunnel I2C bus` if cros, depending on `CROS_EC`
  - select `SPI support`
    - select `BCM2835 SPI controller` if rpi
    - select `BCM2835 SPI auxiliary controller` if rpi
    - select `MediaTek SPI controller` if mtk
    - select `MediaTek SPI NOR controller` if mtk
    - select `PXA2xx SSP SPI master` if intel
    - select `QTI QSPI controller` if qcom
    - select `Qualcomm GENI based SPI controller` if qcom
    - select `Rockchip SPI controller driver` if rk
    - select `Rockchip Serial Flash Controller (SFC)` if rk
  - select `SPMI support` if arm
    - select `Mediatek SPMI Controller (PMIC Arbiter)` if mtk
  - select `Pin controllers`
    - select `AMD GPIO pin control` if amd
    - select `Intel pinctrl drivers` if intel
      - select desired drivers such as
      - select `Intel Meteor Lake pinctrl and GPIO driver`
      - select `Intel Tiger Lake pinctrl and GPIO driver`
    - select `MediaTek pinctrl drivers` if mtk
      - select desired drivers
    - if qcom
      - select `Qualcomm core pin controller driver`
        - select `Qualcomm Technologies Inc SC7180 pin controller driver`
        - select `Qualcomm Technologies Inc SC7280 pin controller driver`
      - select `Qualcomm SPMI PMIC pin controller driver`
      - select `Qualcomm Technologies Inc LPASS LPI pin controller driver`
        - select `Qualcomm Technologies Inc SC7280 LPASS LPI pin controller driver`, depending on `PINCTRL_LPASS_LPI`
  - select `Power supply class support`
    - select `SBS Compliant gas gauge` if needed
    - select `ChromeOS EC based USBPD charger` if cros, depending on `CROS_EC`
    - select `ChromeOS EC based peripheral charger` if cros, depending on `CROS_EC`
  - select `Hardware Monitoring support`
    - select `AMD Family 10h+ temperature sensor` if amd
    - select `Dell laptop SMM BIOS hwmon driver` if dell
    - select `Intel Core/Core2/Atom temperature sensor` if intel
    - select `Raspberry Pi voltage monitor` if rpi
  - select `Thermal drivers`
    - select `Generic cpu cooling support` if arm
    - select `Generic device cooling support` if arm, depending on `PM_DEVFREQ`
    - select `Mediatek thermal drivers` if mtk
      - select `MediaTek thermal drivers`
        - select `AUXADC temperature sensor driver for MediaTek SoCs`
        - select `LVTS Thermal Driver for MediaTek SoCs`
    - select `Intel thermal drivers` if intel
      - select `X86 package temperature thermal driver`
      - select `ACPI INT340X thermal drivers`
        - select `ACPI INT340X thermal drivers`
      - select `Intel PCH Thermal Reporting Driver` if needed
    - select `Broadcom thermal drivers` if rpi
      - select `Thermal sensors on bcm2835 SoC`
    - select `Generic ADC based thermal sensor` if mtk, depending on `IIO`
    - select `Qualcomm thermal drivers` if qcom
      - select `Qualcomm TSENS Temperature Alarm`, depending on `NVMEM` and `NVMEM_QCOM_QFPROM`
      - select `Qualcomm SPMI PMIC Temperature Alarm`
  - select `Watchdog Timer Support`
    - select `AMD/ATI SP5100 TCO Timer/Watchdog` if amd
    - select `QCOM watchdog` if qcom
    - select `Intel TCO Timer/Watchdog` if intel
    - select `Intel MEI iAMT Watchdog` if intel
    - select `Broadcom BCM2835 hardware watchdog` if rpi
    - select `Mediatek SoCs watchdog support` if mtk
  - select `Multifunction device drivers`
    - select `ChromeOS Embedded Controller multifunction device` if cros, depending on `CROS_EC`
    - select `Intel Low Power Subsystem support in PCI mode` if intel
    - select `MediaTek MT6397 PMIC Support` if mtk
    - select `Qualcomm SPMI PMICs` if qcom
    - select `Rockchip RK806 Power Management Chip` if rk
  - select `Voltage and Current Regulator Support` if arm
    - select `Fixed voltage regulator support`
    - select `Fairchild FAN53555 Regulator` if rk
    - select `ChromeOS EC regulators` if cros
    - select `GPIO regulator support` if rpi
    - select `MediaTek MT6315 PMIC` if mtk
    - select `MediaTek MT6359 PMIC` if mtk
    - select `Qualcomm Technologies, Inc. RPMh regulator driver` if qcom, depending on `QCOM_COMMAND_DB` and `QCOM_RPMH`
    - select `Rockchip RK805/RK808/RK809/RK817/RK818 Power regulators` if rk
  - select `Multimedia support` if desired
    - select `Media device types`
      - select `Cameras/video grabbers support`
      - select `Platform-specific devices` if arm
    - select `Media drivers`
      - select `Media USB Adapters`, depending on `USB`
        - select `USB Video Class (UVC)`
      - select `Media platform devices` if arm
        - select `V4L platform devices`
        - select `Memory-to-memory multimedia devices`
        - select `Mediatek Video Codec driver` if mtk, depending on `MTK_IOMMU` and `MTK_SCP`
        - select `MediaTek MDP v3 driver` if mtk, depending on `MTK_IOMMU`, `MTK_SCP`, and `MTK_CMDQ`
        - select `Qualcomm V4L2 Camera Subsystem driver` if qcom
        - select `Qualcomm Venus V4L2 encoder/decoder driver` if qcom
  - select `Graphics support`
    - select `Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)`
    - select `Enable legacy fbdev support for your modesetting driver` (for vt)
    - select `AMD GPU` if amd
      - select `Always enable userptr write support`
    - select `Intel 8xx/9xx/G3x/G4x/HD Graphics` if intel
      - select `Force probe i915 for selected Intel hardware IDs` (to `*`) if intel
    - select `MSM DRM` if qcom
    - select `DRM Support for Rockchip` if rk
      - deselect `Rockchip VOP driver`
      - select `Rockchip VOP2 driver`
    - select `Virtio GPU driver` if guest
    - select `Broadcom VC4 Graphics` if rpi, depending on `SND_SOC`
      - it requires `CMA` and `DMA_CMA` to work
    - select `Display Panels` if arm
      - select `support for simple panels (other than eDP ones)`, depending on `BACKLIGHT_CLASS_DEVICE`
      - select `support for simple Embedded DisplayPort panels`, depending on `BACKLIGHT_CLASS_DEVICE`
    - select `Display Interface Bridges` if arm
      - select `Display connector support`
      - select `TI SN65DSI86 DSI to eDP bridge` if desired
    - select `DRM Support for Mediatek SoCs` if mtk
      - select `DRM HDMI Support for Mediatek SoCs`
    - select `Simple framebuffer driver` if desired
    - select `Panfrost (DRM support for ARM Mali Midgard/Bifrost GPUs)` if mtk
    - select `Panthor (DRM support for ARM Mali CSF-based GPUs)` if rk
    - select `Backlight & LCD device support`
      - select `Lowlevel Backlight controls`
        - select `Generic PWM based Backlight Driver` if arm, depending on `PWM`
  - select `Sound card support` if desired
    - select `Advanced Linux Sound Architecture`
      - select `Dynamic device file minor numbers`
      - deselect `Support old ALSA API`
      - select `HD-Audio` if x86
        - select `HD Audio PCI`
        - select `Build Realtek HD-audio codec support` if needed
        - select `Build HDMI/DisplayPort HD-audio codec support`
      - select `USB sound devices`
        - select `USB Audio/MIDI driver` if needed
      - select `ALSA for SoC audio support`
        - select `AMD Audio Coprocessor - Renoir support` if amd
          - select `AMD Renoir support for DMIC`
        - select `AMD Audio ACP Common support` if amd and cros
          - select `AMD SOF Machine Driver Support`
        - deselect `Intel ASoC SST drivers`
        - select `Intel Machine drivers` if intel
          - select `Use more user friendly long card names`
          - select `Skylake+ with HDA Codecs`
          - select `SOF with rt5650/rt5682 codec in I2S Mode` if needed
          - select `SOF with nau8825 codec in I2S Mode` if needed
          - select `SoundWire generic machine driver` if needed
        - select `ASoC support for Mediatek MT8195 chip` if mtk
          - select `ASoC Audio driver for MT8195 with MT6359 and I2S codecs`, depending on `MTK_PMIC_WRAP`
        - select `ASoC support for QCOM platforms` if qcom
          - select `SoC Machine driver for SC7180 boards`
          - select `SoC Machine driver for SC7280 boards`, depending on `SOUNDWIRE`
        - select `Sound Open Firmware Support` if intel or cros
          - select `SOF PCI enumeration support` if x86
          - select `SOF OF enumeration support` if arm
          - select `SOF support for AMD audio DSPs` if amd
            - select `SOF support for RENOIR`
            - select `SOF support for REMBRANDT`
          - select `SOF support for Intel audio DSPs` if intel
            - deselect all but desired drivers such as
            - select `SOF support for Tigerlake`
            - select `SOF support for Alderlake`
            - select `SOF support for Meteorlake`
            - select `SOF support for HDA Links(HDA/HDMI)`
              - select `SOF support for HDAudio codecs`
          - select `SOF support for MTK audio DSPs` if mtk
            - select `SOF support for MT8195 audio DSP`
        - select `CODEC drivers` if qcom
          - select `Qualcomm VA Macro in LPASS(Low Power Audio SubSystem)`
          - select `Qualcomm RX Macro in LPASS(Low Power Audio SubSystem)`
          - select `Qualcomm TX Macro in LPASS(Low Power Audio SubSystem)`
  - select `HID bus support`
    - select `HID bus core support`
      - select `Battery level reporting for HID devices`
      - select `Special HID drivers`
        - deselect all but the desired drivers, such as
        - select `Google Hammer Keyboard`, depending on `CROS_EC` and `LEDS_CLASS`
        - select `Vivaldi Keyboard`
        - select `Logitech devices`
          - select `Logitech receivers full support`, depending on `HIDRAW`
          - select `Logitech HID++ devices support`
        - select `HID Multitouch panels`
        - select `Nintendo Joy-Con and Pro Controller support`
        - select `Wacom Intuos/Graphire tablet support (USB)`
        - select `HID Sensors framework support`
    - select `I2C HID support`
      - select `HID over I2C transport layer ACPI driver` if x86 (for I2C touchpads)
      - select `HID over I2C transport layer Open Firmware driver` if arm
      - select `Driver for Goodix hid-i2c based devices on OF systems` if needed
    - select `AMD SFH HID Support` if amd
      - select `AMD Sensor Fusion Hub`
  - select `USB support`
    - select `Support for Host-side USB`
    - select `xHCI HCD (USB 3.0) support` if needed
      - select `xHCI support for MediaTek SoCs` if mtk
    - select `EHCI HCD (USB 2.0) support` if needed
      - select `Generic EHCI driver for a platform device` if rk
    - select `USB Printer support` if needed
    - select `USB Mass Storage support`
    - select `DesignWare USB3 DRD Core Support` if qcom or rk
    - select `Onboard USB hub support` if qcom
    - select `USB Type-C Support`
      - select `USB Type-C Connector System Software Interface driver`
        - select `UCSI ACPI Interface Driver` if x86
      - select `USB Type-C Multiplexer/DeMultiplexer Switch support`
        - select `Intel PMC mux control` if intel, depending on `INTEL_SCU_PLATFORM`
    - select `USB Role Switch Support`
  - select `MMC/SD/SDIO card support` if desired
    - select `Secure Digital Host Controller Interface support` if needed
      - select `SDHCI support on PCI bus` if x86
      - select `SDHCI support for ACPI enumerated SDHCI controllers` if x86
      - select `SDHCI platform and OF driver helper` if arm
        - select `SDHCI OF support for the Synopsys DWC MSHC` if rk
    - select `SDHCI support for the BCM2835 & iProc SD/MMC Controller` if rpi
    - select `Qualcomm SDHCI Controller Support` if qcom
    - select `Realtek PCI-E SD/MMC Card Interface Driver` if needed, depending on `MISC_RTSX_PCI`
    - select `MediaTek SD/MMC Card Interface support` if mtk
  - select `LED Support`
    - select `LED Class Support`
    - select `PWM driven LED Support` if arm, depending on `PWM`
    - select `LED support for Qualcomm LPG` if newer qcom, depending on `LEDS_CLASS_MULTICOLOR`
  - select `EDAC (Error Detection And Correction) reporting (NEW)`, depending on `RAS`
    - deselect `EDAC legacy sysfs`
    - select `Intel client SoC Integrated MC` if intel
    - select `QCOM EDAC Controller` if qcom, depending on `QCOM_LLCC`
  - select `Real Time Clock`
    - select `Chrome OS EC RTC driver` if cros, depending on `CROS_EC`
    - select `MediaTek PMIC based RTC`, if mtk
  - select `DMA Engine support`
    - select `BCM2835 DMA engine support` if rpi
    - select `Intel integrated DMA 64-bit support` if intel
    - select `Synopsys DesignWare AHB DMA platform driver` if intel
  - select `DMABUF options` if desired
    - select `userspace dmabuf misc driver`
  - select `Virtio drivers` if guest
    - select `PCI driver for virtio devices`
    - select `Virtio input driver`
  - select `VHOST drivers` if kvm
    - select `Host kernel accelerator for virtio net`
    - select `vhost virtio-vsock driver`
  - select `Staging drivers`
    - select `Broadcom VideoCore support` if rpi
      - select all
  - select `Platform support for Chrome hardware` if cros
    - select `ChromeOS specific ACPI extensions` if x86
    - select `Chrome OS pstore support` if x86
    - select `ChromeOS Embedded Controller`
      - select `ChromeOS Embedded Controller (rpmsg)` if mtk
      - select `ChromeOS Embedded Controller (SPI)`
      - select `ChromeOS Embedded Controller (UART)` if amd, depending on `SERIAL_DEV_BUS`
      - select `ChromeOS Embedded Controller (LPC)` if x86
    - select `Backlight LED support for Chrome OS keyboards`
  - select `X86 Platform Specific Device Drivers` if x86
    - select `WMI`
    - select `AMD SoC PMC driver` if amd
    - select `Dell X86 Platform Specific Device Drivers` if dell
    - select `Lenovo IdeaPad Laptop Extras` if ideapad
    - select `ThinkPad ACPI Laptop Extras` if thinkpad
    - select `Lenovo WMI-based systems management driver` if thinkpad
    - select `Intel PMC Core driver` if intel
    - select `Intel Platform Monitoring Technology (PMT) Telemetry driver` if intel, depending on `INTEL_VSEC`
    - select `Intel HID Event` if intel
    - select `Intel SCU platform driver` if intel
  - select `Common Clock Framework` if arm
    - select `Broadcom BCM2835 clock support` if rpi
    - select `Raspberry Pi firmware based clock support` if rpi
    - select `Clock driver for MediaTek SoC` if mtk
    - select `Support for Qualcomm's clock controllers` if qcom
      - select `RPMh Clock Driver`
      - select `SC7180 *`
      - select `SC7280 *`
  - select `Hardware Spinlock drivers` if qcom
    - select `Qualcomm Hardware Spinlock device`
  - select `Mailbox Hardware Support` if arm
    - select `BCM2835 Mailbox` if rpi
    - select `Qualcomm APCS IPC driver` if qcom
    - select `MediaTek ADSP Mailbox Controller` if mtk
    - select `MediaTek CMDQ Mailbox Support` if mtk
    - select `Qualcomm Technologies, Inc. IPCC driver` if qcom
  - select `IOMMU Hardware Support`
    - select `AMD IOMMU support` if amd
    - select `Support for Intel IOMMU using DMA Remapping Devices` if intel
    - select `Support for Interrupt Remapping` if x86
    - select `Rockchip IOMMU Support` if rk
    - select `ARM Ltd. System MMU (SMMU) Support` if qcom
    - select `ARM Ltd. System MMU Version 3 (SMMUv3) Support` if rk
    - select `MediaTek IOMMU Support` if mtk
    - select `Virtio IOMMU driver` if guest
  - select `Remoteproc drivers` if arm
    - select `Support for Remote Processor subsystem`
      - select `Mediatek SCP support` if mtk
      - select `Qualcomm Technology Inc ADSP Peripheral Image Loader` if qcom
      - select `Qualcomm Hexagon V5 self-authenticating modem subsystem support` if qcom
      - select `Qualcomm sysmon driver` if qcom modem
      - select `Qualcomm WCNSS Peripheral Image Loader` if qcom modem
  - select `Rpmsg drivers` if arm
    - select `MediaTek SCP` if mtk
    - select `Qualcomm SMEM Glink driver` if qcom
    - select `Qualcomm Shared Memory Driver` if qcom modem
  - select `SoundWire support`
    - select `AMD SoundWire Manager driver` if amd
    - select `Intel SoundWire Master driver` if intel
    - select `Qualcomm SoundWire Master driver` if qcom
  - select `SOC (System On Chip) specific Drivers` if arm
    - select `Broadcom SoC drivers` if rpi
      - select `Raspberry Pi power domain driver`
    - select `MediaTek SoC drivers` if mtk
      - select `MediaTek CMDQ Support`
      - select `MediaTek PMIC Wrapper Support`
      - select `MediaTek Smart Voltage Scaling(SVS)`, depending on `NVMEM_MTK_EFUSE`
    - select `Qualcomm SoC drivers` if qcom
      - select `Qualcomm AOSS Driver`
      - select `Qualcomm Command DB`
      - select `QCOM GENI Serial Engine Driver`
      - select `Qualcomm Technologies, Inc. LLCC driver`
      - select `Qualcomm Remote Filesystem memory driver`
      - select `Qualcomm RPM-Hardened (RPMH) Communication`
      - select `Qualcomm Shared Memory Manager (SMEM)`
      - select `Qualcomm Shared Memory Point to Point support`
      - select `Qualcomm socinfo driver`
      - select `Qualcomm Technologies, Inc. (QTI) Sleep stats driver`
      - select `Qualcomm APR/GPR Bus (Asynchronous/Generic Packet Router)`
      - select `QCOM Interconnect Bandwidth Monitor driver`
  - select `PM Domains` if arm
    - select `Qualcomm PM Domains` if qcom
      - select `Qualcomm RPMh Power domain driver`
    - select `Rockchip generic power domain` if rk
  - select `Generic Dynamic Voltage and Frequency Scaling (DVFS) support` if arm
    - select `Simple Ondemand`
    - select `Performance`
    - select `DEVFREQ-Event device Support`
  - select `External Connector Class (extcon) support`
    - select `ChromeOS Embedded Controller EXTCON support` if cros and mtk
  - select `Industrial I/O support`
    - select `Accelerometers`
      - select `HID Accelerometers 3D` if desired (tablets, 2-in-1s)
    - select `Analog to digital converters`
      - select `MediaTek AUXADC driver` if mtk
      - select `Qualcomm Technologies Inc. SPMI PMIC5 ADC` if qcom
      - select `Rockchip SARADC driver` if rk, depending on `RESET_CONTROLLER`
    - select `ChromeOS EC Sensors Core` if cros
      - select `ChromeOS EC Contiguous Sensors`
      - select `ChromeOS EC Sensor for lid angle`
    - select `Light sensors`
      - select `ACPI Ambient Light Sensor` if needed
      - select `ChromeOS EC Light and Proximity Sensors` if cros
    - select `Proximity and distance sensors`
      - select `SX9310/SX9311 Semtech proximity sensor` if needed
      - select `SX9324 Semtech proximity sensor` if needed
  - select `Pulse-Width Modulation (PWM) Support` if arm
    - select `BCM2835 PWM support` if rpi
    - select `ChromeOS EC PWM driver` if cros
    - select `MediaTek display PWM driver` if mtk
    - select `Rockchip PWM support` if rk
  - select `IRQ chip support` if qcom
    - select `QCOM PDC`
  - select `Reset Controller Support` if arm
    - select `Qcom AOSS Reset Driver` if qcom
    - select `Qualcomm PDC Reset Driver` if qcom
    - select `Raspberry Pi 4 Firmware Reset Driver` if rpi
    - select `TI SYSCON Reset Driver` if mtk
  - select `PHY Subsystem` if arm
    - if mtk
      - select `MediaTek PCIe-PHY Driver`
      - select `MediaTek T-PHY Driver`
    - if qcom
      - select `Qualcomm eDP PHY driver`
      - select `Qualcomm QMP PHY Driver`
      - select `Qualcomm QUSB2 PHY Driver`
      - select `Qualcomm SNPS FEMTO USB HS PHY V2 module`
    - if rk
      - select `Rockchip INNO USB2PHY Driver`, depending on `EXTCON`
      - select `Rockchip NANENG COMBO PHY Driver`
      - select `Rockchip Samsung HDMI/eDP Combo PHY driver`
      - select `Rockchip Snps PCIe3 PHY Driver`
      - select `Rockchip USBDP COMBO PHY Driver`
  - select `Generic powercap sysfs driver` if x86
    - select `Intel RAPL Support via MSR Interface`, depending on `IOSF_MBI`
  - select `Reliability, Availability and Serviceability (RAS) features`
  - select `Unified support for USB4 and Thunderbolt` if needed
  - select `NVMEM Support` if arm
    - select `Mediatek SoCs EFUSE support` if mtk
    - select `QCOM QFPROM Support` if qcom
    - select `Rockchip OTP controller support` if rk
  - select `Trusted Execution Environment support`
    - select `OP-TEE` if arm
    - select `AMD-TEE` if amd
  - select `On-Chip Interconnect management support` if qcom
    - select `Qualcomm Network-on-Chip interconnect drivers`
    - select `Qualcomm OSM L3 interconnect driver`
    - select `Qualcomm SC7180 interconnect driver`
    - select `Qualcomm SC7280 interconnect driver`
- select `Cryptographic API`
  - select `Hardware crypto devices`
    - select `Support for AMD Secure Processor` if amd
      - select `Secure Processor device driver`
        - select `Cryptographic Coprocessor device`
          - deselect `Encryption and hashing offload support` if raven (boot issue)

## Config: cros

- chromebooks built-in firmwares
  - <https://chromium.googlesource.com/chromiumos/overlays/chromiumos-overlay/+/refs/heads/main/eclass/cros-kernel2.eclass>
  - grunt: `builtin_fw_amdgpu_stoney`
  - zork: `builtin_fw_amdgpu_picasso` and `builtin_fw_amdgpu_raven2`
  - guybrush: `builtin_fw_amdgpu_green_sardine` and
              `builtin_fw_amdgpu_renoir`
  - skyrim: `builtin_fw_amdgpu_gc_10_3_7` and
            `builtin_fw_amdgpu_yellow_carp`
  - brya: `builtin_fw_guc_adl`, `builtin_fw_huc_adl`,
          `builtin_fw_x86_adl_ucode`, and `builtin_fw_x86_rpl_ucode`
- cros userspace
  - pid 1 is upstart with configs in `/etc/init`
  - the first service is `pre-startup.conf`
    - it triggers `startup.conf` and `udev.conf`
    - `startup.conf` triggers `boot-services.conf` which triggers `shill.conf`
      and `ui.conf`
    - `udev.conf` triggers `udev-boot.conf` which triggers
      `udev-trigger-early.conf` which triggers `boot-splash.conf`
  - `startup.conf` starts `chromeos_startup`
    - this mounts filesystems and restores selinux contexts among other things
  - `boot-splash.conf` starts `frecon`
    - pts/0 is for boot splash
    - pts/1 to pts/3  are for agetty
  - `shill.conf` starts `shill`
    - this is the network manager
  - `ui.conf` starts `session_manager`
    - this replaces the boot splash
- `chromeos_startup` requires
  - `cros_debug` in `CONFIG_CMDLINE` for developer mode
    - `CONFIG_CMDLINE="console=ttyS0,115200 console=tty0 root=/dev/foo rootwait rw cros_debug"`
    - or non-built-in `root=PARTUUID=%U/PARTNROFF=1` and let depthcharge
      expand `%U`
  - dm
    - `CONFIG_MD=y`
    - `CONFIG_BLK_DEV_DM=y`
    - `CONFIG_DM_CRYPT=y`
    - `CONFIG_DM_THIN_PROVISIONING=y`
    - `CONFIG_DM_VERITY=y`
    - `CONFIG_CRYPTO_AES_NI_INTEL=y`
  - filesystems
    - `CONFIG_EXT4_FS_SECURITY=y`
    - `CONFIG_SQUASHFS=y`
    - `CONFIG_SQUASHFS_XATTR=y`
    - `CONFIG_SQUASHFS_LZ4=y`
    - `CONFIG_SQUASHFS_LZO=y`
    - `CONFIG_SQUASHFS_ZSTD=y`
  - selinux
    - `CONFIG_AUDIT=y`
    - `CONFIG_SECURITY=y`
    - `CONFIG_SECURITY_NETWORK=y`
    - `CONFIG_SECURITY_SELINUX=y`
    - `CONFIG_LSM="selinux"`
- `cros_config_setup` requires
  - `CONFIG_CHROMEOS_ACPI=y` or `CONFIG_ACPI_CHROMEOS=y` (downstream)
- `shill` requires
  - `CONFIG_IP_ADVANCED_ROUTER=y`
  - `CONFIG_IP_MULTIPLE_TABLES=y`
  - `CONFIG_IPV6_MULTIPLE_TABLES=y`
  - `CONFIG_CFG80211=y`
- `session_manager` requires
  - the pre-start script requires cgroups
    - `CONFIG_BLK_CGROUP=y`
    - `CONFIG_CFS_BANDWIDTH=y`
    - `CONFIG_CGROUP_FREEZER=y`
    - `CONFIG_CPUSETS=y`
    - `CONFIG_CGROUP_DEVICE=y`
    - `CONFIG_CGROUP_CPUACCT=y`
    - `CONFIG_CGROUP_BPF=y`
  - cryptohome requires quota
    - `CONFIG_QUOTA=y`
    - `CONFIG_QFMT_V2=y`
- random requirements
  - `boot-update-firmware.conf` blocks `ui.conf` for 15s unless
    - `CONFIG_I2C_CHARDEV=y`
    - this is because of `chromeos-touch-update.sh`
      - funny that fw update uses `CONFIG_HIDRAW=y` instead
  - `bluetoothd` requires
    - `CONFIG_BT=y`
  - `conntrackd` requires
    - `CONFIG_NETFILTER=y`
    - and many more
  - `cros-camera` requires a camera
    - `CONFIG_MEDIA_SUPPORT=y`
    - `CONFIG_MEDIA_CAMERA_SUPPORT=y`
    - `CONFIG_MEDIA_USB_SUPPORT=y`
    - `CONFIG_USB_VIDEO_CLASS=y`
  - `memd` requires
    - `CONFIG_LOW_MEM_NOTIFY=y` (downstream only)
  - `cros-disks` requires
    - `CONFIG_FUSE_FS=y`
  - `u2fd` requires
    - `CONFIG_UHID=y`
  - `kmsvnc` requires
    - `CONFIG_INPUT_UINPUT=y`
  - mmc requires
    - `CONFIG_MMC_BLOCK_MINORS=16`

## Finding Drivers

- `find /sys/devices -name driver | xargs readlink -e | sort | uniq`
  - this lists all drivers that are bound to some devices
  - no unused driver
  - modules that discover and create the devices but are not themselves
    drivers are not included
- it is easy to find module names from here
  - some drivers does not have `module` links because they are built-in and
    they fail to set `device_driver::mod_name`
