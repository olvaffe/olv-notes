USB
===

## USB

- USB 1.0
  - 1996
  - Low Speed: 1.5Mbit/s
  - Connectors: Type {A,B}
- USB 1.1
  - 1998
  - Full Speed: 12Mbit/s
  - Connectors: Type {A,B} and Mini-{A,B}
- USB 2.0
  - 2000
  - High Speed: 480Mbit/s
  - Connectors: Type {A,B,C}, Mini-{A,B,AB} and Micro-{A,B,AB}
  - On-The-Go 1.3
  - Battery Charging Spec 1.1 and 1.2
- USB 3.0
  - 2008
  - SuperSpeed: 5Gbit/s
    - Type {A,B} are blue connectors with SS initials
  - Connectors: Type {A,B,C}, Micro-{A,B,AB}
- USB 3.1
  - 2013
  - Gen1: USB 3.0 rebranded
  - Gen2: SuperSpeed+: 10Gbit/s
  - Connectors: Type {A,B,C}, Micro-{A,B,AB}
  - USB PD
- USB 3.2
  - 2017
  - Gen 1x1: 5Gbit/s
  - Gen 1x2: 10Gbit/s (two lanes)
  - Gen 2x1: 10Gbit/s
  - Gen 2x2: 20Gbit/s (two lanes)
  - Connector: Type C only
- USB4
  - 2019
  - can tunnel
    - USB 3.2
    - DisplayPort 1.4a
    - PCIe
  - Gen 3x1: 20Gbit/s
  - Gen 3x2: 40Gbit/s (two lanes)
- USB4 2.0
  - 2022
  - Gen 4x1: 40Gbit/s
  - Gen 4x2: 80Gbit/s (two lanes)
- Power
  - Low Power: 5V * 0.1A = 0.5W
  - High Power: up to 5V * 0.5A = 2.5W
  - Low Power SuperSpeed: 5V * 0.15A = 0.75W
  - High Power SuperSpeed: up to 5V * 0.9A = 4.5W
  - Two-Lane SuperSpeed (3.2 Gen2x2): up to 5V * 1.5A = 7.5W
  - BC 1.2: 5V * 1.5A = 7.5W
  - USB-C: 5V * 1.5A = 7.5W
           5V * 3A = 15W
- USB Type-A
  - USB 1.0 and 2.0 has 4 pins: VBUS, D-, D+, and GND
  - USB 3.0 has 9 pins: 4 pins plus RX-, RX+, TX-, TX+, GND
- USB Type-C
  - revisions
    - 1.0, 2014
    - 1.1, 2015
    - 1.2, 2016
    - 1.3, 2017
    - 1.4, 2019
    - 2.0, 2019
    - 2.1, 2021, USB PD up to 240W
    - 2.2, 2022, USB4 2.0
  - alternate mode
    - this is different from USB4 / TB3 tunnelling
    - DisplayPort 1.2, 1.4, 2.0
    - Thunderbolt 3
    - HDMI 1.4b
  - Cable
    - SuperSpeed is optional
    - alternate mode is optional
    - PD is optional
- USB Power Delivery
  - 1.0
    - 5V: 2A
    - 12V: 1.5A, 3A, 5A
    - 20V: 3A, 5A
  - 2.0/3.0
    - 5V: 0.1A ~ 3A
    - 9V: 1.67A ~ 3A
    - 15V: 1.8A ~ 3A
    - 20V: 2.25A ~ 5A
  - 3.1
    - 28V
    - 36V
    - 48V: 5A
- Connectors
  - most common: type A, type C
  - was common: mini B, micro B
  - less common: type B
  - rare: mini A and micro A
- Chargers
  - MacBook: 87W
  - Laptop: 65W, 45W
  - Phone: 18W, 30W
- Pinouts
  - usb 1.x and 2.0 have 4 pins on the same side
    - VBUS, D-, D+, GND
  - usb 3.0 has 9 pins on the same side
    - VBUS, D-, D+, GND
    - TX-, TX+, GND, RX-, RX+
    - <https://www.kernel.org/doc/html/latest/driver-api/usb/usb3-debug-port.html>
      - usb 3.0 a-to-a debug cable lacks VBUS/D-/D+
      - the dut can be configured such that its xhci controller functions as a
        usb device instead of a usb host
  - type-c has 24 pins
    - symmetrical 12 pins on each side, to be flippable
    - other than the 9 pins, new pins on each side are: CC (for pd), SBU (for
      altmode), and second VBUS
  - a type-a connector can internally connect to both 2.0 and 3.0 controllers
    - it can use pin counts to tell between 2.0 and 3.0 cables
  - a type-c connector is similar
  - as such, a usb cable or adapter can have 4, 9, or 24 pins
  - inferior usb-c cables
    - usb 2.0: no TX/RX
    - no altmode: no SBU
    - power-only: only VBUS, CC, GND (and symmetrical, so 6 pins)

## USB Device Classes

- 00, Unspecified
  - Device class is unspecified, interface descriptors are used to determine needed drivers
- 01, Audio
  - Speaker, microphone, sound card, MIDI
- 02, Communications and CDC control
  - UART and RS-232 serial adapter, modem, Wi-Fi adapter, Ethernet adapter.
    Used together with class 0Ah (CDC-Data) below
- 03, Human interface device (HID)
  - Keyboard, mouse, joystick
- 05, Physical interface device (PID)
  - Force feedback joystick
- 06, Media (PTP/MTP)
  - Scanner, Camera
- 07, Printer
  - Laser printer, inkjet printer, CNC machine
- 08, USB mass storage, USB Attached SCSI
  - USB flash drive, memory card reader, digital audio player, digital camera,
    external drive
- 09, USB hub
  - High speed USB hub
- 0A, CDC-Data
  - Used together with class 02h (Communications and CDC Control) above
- 0B, Smart card
  - USB smart card reader
- 0D, Content security
  - Fingerprint reader
- 0E, Video
  - Webcam
- 0F, Personal healthcare device class (PHDC)
  - Pulse monitor (watch)
- 10, Audio/Video (AV)
  - Webcam, TV
- 11, Billboard
  - Describes USB-C alternate modes supported by device
- DC, Diagnostic device
  - USB compliance testing device
- E0, Wireless Controller
  - Bluetooth adapter
- EF, Miscellaneous
  - ActiveSync device
- FE, Application-specific
  - IrDA Bridge, RNDIS, Test & Measurement Class (USBTMC), USB DFU (Device
    Firmware Upgrade)
- FF, Vendor-specific
  - Indicates that a device needs vendor-specific drivers

## XHCI PCI

- `xhci_pci_init` registers
  - a pci driver, `xhci_pci_driver`
  - a usb host controller driver, `xhci_pci_hc_driver`
- `xhci_pci_driver` matches against `PCI_CLASS_SERIAL_USB_XHCI`
  - `usb_hcd_pci_probe` probes the pci device
    - `usb_create_hcd` creates a `usb_hcd`
      - HCD stands for host controller driver
      - it also reserves `hcd_priv_size` for `hcd->hcd_priv`, which is used
        for `xhci_hcd`
    - `usb_add_hcd` adds the `usb_hcd` to the core

## ThinkPad X1 Carbon Gen 9

- lspci
  - two thunderbolt controllers
    - `Intel Corporation Tiger Lake-LP Thunderbolt 4 NHI #0`
    - `Intel Corporation Tiger Lake-LP Thunderbolt 4 NHI #1`
  - two xhci controllers
    - `Intel Corporation Tiger Lake-LP Thunderbolt 4 USB Controller`
      - it provides a 1-port 2.0 hub (bus 1)
      - it also provides a 4-port 3.0 hub (bus 2)
    - `Intel Corporation Tiger Lake-LP USB 3.2 Gen 2x1 xHCI Host Controller`
      - it provides a 12-port 2.0 hub (bus 3)
      - it also provides a 4-port 3.0 hub (bus 4)
- user manual
  - left side
    - USB-C (Thunderbolt 4) power connector
      - usb 2.0 dev uses bus 3, port 6
      - usb 3.0 dev uses bus 2, port 3
    - USB-C (Thunderbolt 4) connector
      - usb 2.0 dev uses bus 3, port 5
      - usb 3.0 dev uses bus 2, port 2
    - USB 3.2 connector Gen 1
      - usb 2.0 dev uses bus 3, port 1
      - usb 3.0 dev uses bus 4, port 1
  - right side
    - Always on USB 3.2 connector Gen 1
      - usb 2.0 dev uses bus 3, port 7
      - usb 3.0 dev uses bus 4, port 2
- internal usb devices
  - fingerprint reader uses bus 3, port 3
  - camera uses bus 3, port 4
  - bt uses bus 3, port 10
