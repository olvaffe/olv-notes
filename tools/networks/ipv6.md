IPv6
====

## IPv4 Addresses

- an IPV4 address has 32 bit and is represented by `192.168.0.1`
  - four groups of 3 digits
  - each group representing 8 bits
  - groups are separated by dots
- CIDR notation `192.168.0.1/24`
  - the addr is followed by a slash and the count of consecutive 1 bits
  - `/24` means `255.255.255.0` which is the routing prefix / subnet mask
- special-use addresses
  - `0.0.0.0/8`: local network
  - `10.0.0.0/8`: private network
  - `100.64.0.0/10`: for isp and subscribers
  - `127.0.0.0/8`: loopback
  - `169.254.0.0/16`: link-local
  - `172.16.0.0/12`: private network
  - `192.0.0.0/24`: protocol assignment
  - `192.0.2.0/24`: docs and examples
  - `192.88.99.0/24`: reserved
  - `192.168.0.0/16`: private network
  - `198.18.0.0/15`: benchmark
  - `198.51.100.0/24`: docs and examples
  - `203.0.113.0/24`: docs and examples
  - `224.0.0.0/4`: multicast
    - `233.252.0.0/24`: docs and examples
  - `240.0.0.0/4`: reserved
  - `255.255.255.255/32`: limited broadcast

## IPv6 Addresses

- an IPv6 address has 128 bits and is represented by
  `1111:2222:3333:4444:aaaa:bbbb:cccc:dddd`
  - eight groups of four hexadecimal digits
  - each group representing 16 bit
  - groups are separated by colons
- canonical text format
  - recommended to be in lower cases
  - leading zeros in each group are suppressed, but each group must retain at
    least 1 digit
    - e.g., `1:0:0:0:1:0:0:1`
  - then the longest consecutive all-zero groups are replaced by two colons
    - e.g., `1::1:0:0:1`
    - if there are two such sequences of the same size, the leftmost one is
      compressed
- unicast and anycast address format
  - the first 64 bits are network prefix used for routing
    - it can be further divided into routing prefix and subnet id
    - a larger routing prefix means a smaller subnet
  - the last 64 bits are interface identifier
    - it can be autogenerated from MAC addr
    - or from DHCPv6 or assigned manully like in IPv4
- multicast address format
  - 8-bit prefix which is always `ff`
  - 4-bit flag
  - 4-bit scope
  - 112-bit group id
- special addresses
  - `::/0`: default route
  - `::/128`: unspecified address
  - `::1/128`: loopback address
  - `::ffff:0:0/96`: IPv4 mapped
  - `::ffff:0:0:0/96`: IPv4 translated
  - `64:ff9b::/96`: global IPv4/IPv6 translation
  - `64:ff9b:1::/96`: private IPv4/IPv6 translation
  - `100::/64`: discard prefix
  - `2001:0000::/32`: Teredo tunneling
  - `2001:20::/28`: ORCHIDv2
  - `2001:db8::/32`: used in docs as examples
  - `2002::/16`: 6to4 scheme (deprecated)
  - `fc00::/7`: unique local addresses
    - private networks similar to `192.168.0.0/24` in IPv4
    - `fc00::/8` is not defined and only `fd00::/8` is used
  - `fe80::/64` from `fe80::/10`: link local address
    - similar to `169.254.0.0/16` in IPv4
  - `ff00::/8`: multicast
    - `ff01::/16`: node-local
    - `ff02::/16`: link-local
      - `ff02::1` all nodes
      - `ff02::2` all routers
      - `ff02::1:2` all DHCP servers

## Examples

- my eth0 has 3 IPv6 addresses (and 1 IPv4 address)
  - one is in `fe80::/64`
    - this is the link local addr
    - typically generated by SLAAC, where the 64-bit interface identifier is
      pseudo-random
  - one is in a `/64` network
    - typically generated in response to RA
    - both kernel and userspace can handle RA
    - systemd-networkd uses EUI-64 by default
      - no privacy (derived from mac addr)
      - `Token=prefixstable` to use stable private addr instead
    - NM uses stable private addr by default
      - RFC 7217, private and stable
      - `ipv6.addr-gen-mode=eui64` to use EUI-64 instead
  - one is temporary in the same `/64` network
    - RFC 4941, private but unstable
    - this is pseudo-random using the addr above as a template
- `man ip-address`
  - `scope global` is globally valid
  - `scope link` is link local
  - `scope host` is valid in the host
  - `proto kernel_lo` is kernel-generated loopback (`::1/128`)
  - `proto kernel_ll` is kernel-generated link-local (`fe80::/64`)
  - `proto kernel_ra` is kernel-generated in response to RA
  - `temporary` uses a randomly generated interface id, for better privacy
    - kernel can generate one if `net.ipv6.conf.all.use_tempaddr` is set
    - nm can generate one if `ipv6.ip6-privacy` is set
  - `dynamic`/`permanent` means the address is generated or manually assigned
  - `mngtmpaddr` uses this address as a template for temporary addresses
  - `noprefixroute` does not automatically create a route for the network of the address
- to see only the primary IPv6 addresses,
  - `ip -6 address show dev eth0 primary`

## internal network

- called ULA (unique local address)
  - `fc00::/7`
  - similar to `192.168.0.0/16`
- let's use `fddd:59c2:214b::/48` for the router
  - `ip addr add fddd:59c2:214b::1/48 dev eth0`
- how do machines in the network get their addresses?
  - `radvd`

## 6to4

- suppose we have an IPv4 address, how do we connect to IPv6 network?
- suppose we have an IPv4 address, how do we listen to an IPv6 address?

## DHCPv6

- ISPs usually use DHCPv6 to configure home routers
- handshake
  - the client (home router) uses its link-local address and udp port 546
  - the server (usually a relay) listens on the link-local multicast address
    `ff02::1:2` and udp port 547
  - the client sends a `SOLICIT` meesage to the multicast address
    - it includes configuration options
  - server(s) replies a `ADVERTISE` meesage(s)
    - it includes requested information (prefix delecation, nameserver, etc.)
  - the client sends a `REQUEST` meesage to the multicast address
    - this message identifies the server that the client prefers
  - the server replies a `REPLY` meesage
- the client has the information it requests
  - gateway: usually a link-local address
  - prefix delegation: a network that the client can use
    - IPS router will route all traffic sent to the network to the client
- with the information at hand, the client (home router) can 
  - use SLAAC to configure its address
    - or, if an address is assigned by DHCPv6, use that address
  - use Router Advertisement to configure its clients (home devices)
    - similar to DHCPv6, the info includes the network prefix and the gateway
      (another link-local address of the home router)
    - home devices use SLAAC to configure themselves
    - the home router can also use DHCPv6 if it chooses to
- in this setup, the client and its clients usually use globally unique
  addresses

## Router Advertisement

- they are ICMPv6 messages
- the client sends a RS (Router Solicitation) message from its link-local
  address to `ff02::2` (all routers)
- routers send a RA (Router Advertisement) message from its link-local address
  to `ff02::1` (all nodes)
  - the mssage includes several options
  - option 3: prefix info, which is the network prefix for SLAAC

## Configuration

- experiments with systemd-networkd
- `LinkLocalAddressing=` defaults to `ipv6`
  - it uses EUI-64 (extended unique identifier) to generate the link-local
    address
  - with mac addr `11:22:33:44:55:66`, it first generates
    `1122:33ff:fe44:5566` and flips bit 7 to become `1322:33ff:fe44:5566`
  - the network prefix is `fe80::/64`
  - if set to `ipv4`, it aasigns `169.254.0.0/16`
- `IPv6AcceptRA=` defaults to `yes`
  - it uses ICMPv6 RA for configuration data
  - it depends on `LinkLocalAddressing` for ICMPv6 to work
- `DHCP=` defaults to `no`
  - it does not use DHCPv4 nor DHCPv6 for configuration data
