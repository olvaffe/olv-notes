Chrome OS CI
============

## CI

- <https://ci.chromium.org/>
- projects
  - chromium <https://ci.chromium.org/p/chromium>
  - fuchsia <https://ci.chromium.org/p/fuchsia>
  - angle <https://ci.chromium.org/p/angle>
- builders
  - each project can have many builders
  - angle's android-arm64-rel
    <https://ci.chromium.org/p/angle/builders/ci/android-arm64-rel>
  - fuchsia's clang-linux-arm64
    <https://ci.chromium.org/p/fuchsia/builders/toolchain.ci/clang-linux-arm64>
  - chromium's Linux Builder
    <https://ci.chromium.org/p/chromium/builders/ci/Linux%20Builder>
- builds
  - each builder can have many builds
  - build 140196 of chromium's Linux Builder
    <https://ci.chromium.org/ui/p/chromium/builders/ci/Linux%20Builder/140196/overview>
- groups
  - a group groups related builders together
  - a group can present a console view
  - a builder can belong to multiple groups

## autotest and tast

- autotest
  - <https://chromium.googlesource.com/chromiumos/third_party/autotest/>
  - `test_that $DUT $TEST_NAME`
- autotest tests
  - `AUTHOR = "chromeos-gfx"`
    - `graphics_Check` takes some screenshots and verifies they are not black.
      Stops ui and draws/readbacks to verify.
    - `graphics_Chrome` runs `ozone_gl_unittests` that tests dma-buf and
      GLImageEGL
    - `graphics_GLAPICheck` runs `wflinfo` and verifies GL/GLES versions and
      extensions
    - `graphics_GLBench` runs `glbench`
    - `graphics_GLMark2` runs `glmark2`
    - `graphics_Gbm` runs minigbm unit tests
    - `graphics_HwOverlays` loads a test webpage and verifies at least two
      overlays are active
    - `graphics_Idle` naviates to a static webpage and verifies that the GPU
      is clocked down
    - `graphics_KernelMemory` verifies drm info is available in sysfs
    - `graphics_LibDRM` runs `modetest` and `kmstest`
    - `graphics_PerfControl` verifies the machine can be cooled down
    - `graphics_Power` runs `power_Test`
    - `graphics_SanAngeles` runs a benchmark
    - `graphics_Stress` navigates to some webpages, restarts chrome, etc
    - `graphics_VTSwitch`
    - `graphics_VideoRenderingPower`
    - `graphics_WebGLAquarium`
    - `graphics_WebGLManyPlanetsDeep`
    - `graphics_dEQP` runs dEQP
    - `graphics_parallel_dEQP` runs dEQP in parallel
    - `graphics_per-build`
    - `graphics_per-day`
    - `graphics_per-week`
    - `vmtest_informational[1-4]`
  - critical CTS
    - `cheets_CTS_R.internal.arm.CtsDeqpTestCases.dEQP-EGL`, 35m
    - `cheets_CTS_R.internal.arm.CtsDeqpTestCases.dEQP-GLES2`, 35m
    - `cheets_CTS_R.internal.arm.CtsDeqpTestCases.dEQP-GLES3`, 200m
    - `cheets_CTS_R.internal.arm.CtsDeqpTestCases.dEQP-GLES31`, 220m
  - fast CTS
    - `cheets_CTS_R.internal.arm.CtsCamera`, 10m
    - `cheets_CTS_R.internal.arm.CtsGpu`, 15m
    - `cheets_CTS_R.internal.arm.CtsGraphics`, 30m
    - `cheets_CTS_R.internal.arm.CtsNNAPI`, 15m
    - `cheets_CTS_R.internal.arm.CtsNative`, 20m
    - `cheets_CTS_R.internal.arm.CtsOpenG`, 15m
    - `cheets_CTS_R.internal.arm.CtsSkQP`, 20m
    - `cheets_CTS_R.internal.arm.CtsUi`, 10m
  - slow CTS
    - `cheets_CTS_R.internal.arm.CtsView`, 160m
    - `cheets_CTS_R.internal.arm.CtsVideo`, 260m
    - `cheets_CTS_R.internal.arm.CtsMediaStressTestCases`, 300m
    - `cheets_CTS_R.internal.arm.CtsMediaTestCases.64`, 900m
    - `cheets_CTS_R.internal.arm.CtsMediaV2TestCases`
- tast
  - <https://chromium.googlesource.com/chromiumos/platform/tast/>
  - <https://chromium.googlesource.com/chromiumos/platform/tast-tests>
- tast tests
  - `tast list <dut>`
    - `graphics.DEQP` runs a very small dEQP subset
    - `graphics.DRM` runs various `drm_tests`
    - `graphics.*`
    - `crostini.*`
    - `arc.Boot.vm`
    - `arc.DEQP.vm`
  - `tast list -buildbundle crosint <dut>`

## `cheets_CTS_R`

- `src/third_party/autotest/files/server/site_tests/cheets_CTS_R`
- `cheets_CTS_R.py`
  - `LATEST` is official cts
  - `DEV` is preview cts
- `control.internal.arm.CtsDeqp*`
  - `cheets_CTS_R.internal.arm.CtsDeqp.32` and `cheets_CTS_R.internal.arm.CtsDeqp.64` use DEV
  - the rest uses LATEST
- what are `suite:arc-cts`, `suite:arc-cts-r`, `suite:arc-cts-unibuild`,
  `suite:arc-cts-qual`, and `suite:arc-cts-hardware`?
  - `infra/suite_scheduler/generated_configs/suite_scheduler.ini`
  - `arc-cts-qual` and `arc-cts-hardware`
    - run on Mon, Wed, and Fri at hour 0 for beta channel
    - run on Sat at hour 0 for stable channel
    - run on Sun at hour 6 for dev channel
    - timeout is 30 hours
  - `arc-cts-r`
    - run on selected days at hour 0 for dev channel
      - Tue: {eve,kukui,trogdor,zork}-arc-r
      - Thu: {kukui,trogdor}-arc-r
      - Sat: kukui-arc-r
      - Sun: zork-arc-r
    - timeout is 43 hours
  - `arc-cts`
    - run on Mon, Wed, and Fri at hour 11 for dev channel
    - run on Tue, Thu, and Sat at hour 0 for dev channel
    - timeout is 30 hours

## `tast.video.PlatformDecodingPerf`

- the subtests (parameters) are generated by `platform_decoding_perf_test.go`
  - codecs are `av1`, `h264`, `hevc`, `vp8`, and `vp9`
  - resolutions are `1080` and `2160`
  - frame rates are `30` and `60`
- take `vaapi_h264_2160p_60fps` for example
  - `filename` is `perf/h264/2160p_60fps_600frames.h264`
    - there is `2160p_60fps_600frames.h264.external` pointing to
      `gs://chromiumos-test-assets-public/tast/cros/video/perf/h264/2160p_60fps_600frames_20190801.h264`
  - `decoder` is `/usr/local/libexec/chrome-binary-tests/decode_test`
  - `decoderArgsBuilder` is `H264DecodeVAAPIargsNoLogs`
    - this generates `--video=<filename> --visible --codec=H264 -v=-1`
- `measurePerformance`
  - it creates two `testexec.Cmd` with different loop args
    - `platform.LoopArgs(exec, 0, 0)` generates `--loop`
    - `platform.LoopArgs(exec, measurementIterations, framesPerIteration)`
      generates `--loop=5 --frames=200`
  - `collectMetricsPerTime`
    - it invokes the decode cmd in the background
    - `graphics.MeasureGPUCounters`
      - it measure gpu counters for `measurementDuration` (25) seconds
    - `graphics.MeasureCPUUsageAndPower`
      - it sleeps for `stabilizationDuration` (5) seconds
      - it measures cpu and power usage for `measurementDuration` (25) seconds
    - it waits for the measurement to complete
  - `collectMetricsPerRun`
    - it decodes the first `framesPerIteration` (200) frames
      `measurementIterations` (5) times
    - it measures the decode time to calculate the fps

## `tast.ui.MeetCUJ`

- `meetTest`
  - `bots` is an array of bot counts
    - the test seesion will be divided into N phases
    - each phase takes `duration / N` minutes and has `bots[i]` bots
  - `layout` picks meet layout (`TiledLayout` or `SpotlightLayout`)
  - `present` presents the doc or jamboard window
  - `docs` creates a doc window
  - `jamboard` creates a jamboard window
  - `split`
  - `cam` turns the camera on
  - `effects` enables meet effects
    - `Apply visual effects`, `Blur your background`
  - `backgroundBlur` enables platform bg blur
  - `adjustLighting` enables platform relighting
  - `liveCaptions` turns on platform live captioning
  - `noiseCancellation` enables platform noise cancellation
  - `zoomOut` zooms out on both the browser and display
    - `ctrl+-` and sleep 3s, for 5 times
  - `tabSwitchDocs` switches between Docs and Meet
    - `alt+tab`, sleep 10s, `alt+tab`
  - `duration` is by default 10 minutes
  - `browserType` is ash or lacros
  - `botsOptions`
- subtests
  - `tast.ui.MeetCUJ.docs`
    - `bots:        []int{1, 3, 15},`
    - `layout:      googlemeet.TiledLayout,`
    - `present:     true,`
    - `docs:        true,`
    - `split:       true,`
    - `cam:         true,`
    - `zoomOut:     true,`
    - `effects:     true,`
    - `browserType: browser.TypeAsh,`
  - `tast.ui.MeetCUJ.docs_lacros`
    - `browserType: browser.TypeLacros,`
  - `tast.ui.MeetCUJ.docs_no_effects`
    - `effects:           false,`
  - `tast.ui.MeetCUJ.docs_audio_effects`
    - `effects:           false,`
    - `liveCaptions:      true,`
    - `noiseCancellation: true,`
  - `tast.ui.MeetCUJ.docs_noise_cancellation`
    - `effects:           false,`
    - `noiseCancellation: true,`
  - `tast.ui.MeetCUJ.docs_live_captions`
    - `effects:           false,`
    - `liveCaptions:      true,`
  - `tast.ui.MeetCUJ.docs_background_blur`
    - `effects:           false,`
    - `backgroundBlur:    true,`
  - `tast.ui.MeetCUJ.docs_adjust_lighting`
    - `effects:           false,`
    - `adjustLighting:    true,`
  - `tast.ui.MeetCUJ.docs_video_effects`
    - `effects:           false,`
    - `backgroundBlur:    true,`
    - `adjustLighting:    true,`
  - `tast.ui.MeetCUJ.docs_platform_effects`
    - `effects:           false,`
    - `backgroundBlur:    true,`
    - `adjustLighting:    true,`
    - `liveCaptions:      true,`
    - `noiseCancellation: true,`
- flow
  - restart ui
  - log in as crosuicujtest1@gmail.com
  - disable play store
  - wait for cpu cooldown
  - create a window and create a meet
  - add 1 bot
  - zoom out to 50%
  - create a window and create a doc
  - show the two windows side-by-side
  - present the doc in meet
  - keep typing into doc
  - after a while, add 2 more bots
  - after a while, add 12 more bots
  - after 10m, done
- `results-chart.json` metrics
  - `Power.system` and `Power.t`
    - this shows power consumption in W at various time points in S
  - `EventLatency.KeyPressed.TotalLatency`
    - this shows keypress latentency in uS
  - `Graphics.Smoothness.PercentDroppedFrames3.AllSequences`
    - this shows frame drop rate in percentage

## `tast.ui.LoginPerf.ash_chrome`

- flow
  - restart ui
  - log in as cros.gaia.testing.13@gmail.com
  - opt in to play store
  - wait for arc to init
  - sign out
  - restart ui
  - repeat
    - sign in and create two windows showing animations
    - sign out
    - restart ui
