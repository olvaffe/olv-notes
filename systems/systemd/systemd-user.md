systemd user sessions
=====================

## Overview

- `man pam_systemd`
  - create `/run/user/$UID`
  - create a user slice and a user service if this is the first login
  - create a user session
- `systemctl status user.slice`
  - a `user-$UID.slice` is created under `user.slice`
  - a `user@$UID.service` is started under `uiser-$UID.slice`
- `man user@.service`
  - this starts `systemd --user` for the user

## `systemd --user`

- this user manager instance is started just before any user session
  - it starts user services
  - it and the services it starts are not in any user session
- `man environment.d`
  - this is how environment variables are set for the user manager instance
  - note that `/etc/environment` is also parsed by `pam_env`, which affects
    user sessions
- `systemctl --user show-environment` shows the environment variables
- because some user services might provide visual feedback, the display server
  in the user session should set `DISPLAY` and/or `WAYLAND_DISPLAY` once the
  display server is started
  - `/etc/sway/config.d/50-systemd-user.conf`
    - `systemctl --user import-environment DISPLAY WAYLAND_DISPLAY SWAYSOCK`
    - `dbus-update-activation-environment --systemd DISPLAY WAYLAND_DISPLAY
         SWAYSOCK`
  - note that units that have been started before the import are not affected;
  - user sessions are also not affected (they get the variables from the
    display server through other means)

## `loginctl`

- show/control sessions, users, and seats
- `loginctl seat-status seat0`
  - shows user sessions and devices assigned to this seat
- `loginctl seat-status $UID`
  - shows the user slice
- `loginctl session-status <session>`
  - shows the user session

## systemd for the session

- goals
  - remove ConsoleKit and `XDG_SESSION_COOKIE`
    - `XDG_SESSION_COOKIE` is generated by ConsoleKit and set by display
      manager
  - automatic multi-seat support
  - on-demand starting of getty
  - covering all of getty, ssh, and x11 sessions
  - introduce d-bus user bus
- <http://www.freedesktop.org/wiki/Software/systemd/multiseat>
  - a seat consists of all hardware devices assigned to a specific workplace
    - a seat is identified by a short string, `seat????`
    - not all hardware devices are assigned to a seat. e.g., disks and
      network cards
  - A session is defined by the time a user is logged in until he logs out
    - a session is bound to one or no (e.g., ssh login) seats
    - multiple sessions can be attached to one seat, but only one of them can
      be active
    - session IDs are unique on the local machine, and is never reused as long
      as the machine is online
  - a user can have multiple sessions at the same time.  A user identified by
    UID or username
  - A multi-session system allows multiple sessions on the same seat at the
    same time
  - A multi-seat system allows multiple independent seats
  - udev rules
    - devices eligible to be assigned are tagged `seat`.  This includes
      graphic devices, mice, keyboards, video cards, sound cards, and more
    - prop `ID_SEAT`: if set, specifies the seat the device is assigned to
    - prop `ID_AUTOSEAT`, if 1, the device creates a new seat
    - prop `ID_FOR_SEAT`: seat id can be `seatID_FOR_SEAT`
