Raspberry Pi
============

## History

- RPi 1 uses BCM2835
  - VideoCore IV, 250MHz
  - ARM1176 (ARMv6)
- RPi 2 uses BCM2836
  - VideoCore IV, 250MHz
  - Cortex-A7 (ARMv7)
- RPi 2 uses BCM2836
  - VideoCore IV, 300MHz
  - Cortex-A53 (ARMv8)
- RPi 2 uses BCM2711
  - Video Core VI, 500MHz
  - Cortex-A72 (ARMv8)

## BCM2835 DT

- BCM2835 CPRMAN clock controller
  - input: external oscillator
  - outputs: `BCM2835_CLOCK_*` clocks
  - compatible: brcm,bcm2835-cprman or brcm,bcm2711-cprman
  - driver: `CONFIG_CLK_BCM2835`
- BCM2835 power manager
  - input: `BCM2835_CLOCK_{V3D,PERI_IMAGE,H264,ISP}`
  - output: `BCM2835_POWER_DOMAIN_*`
  - controls power domains, reset lines, and a watchdog timer
  - compatible: brcm,bcm2835-pm
  - driver: `CONFIG_ARCH_BCM2835`
- BCM2835 VCHIQ firmware service
  - compatible: brcm,bcm283[5-6]-vchiq
  - driver: `CONFIG_BCM2835_VCHIQ`
- BCM2835 System Timer
  - a freerunning counter and 4 timer channels
  - compatible: brcm,bcm2835-system-timer
  - driver: `CONFIG_BCM2835_TIMER` (disabled on RPi4)
- BCM2835 DMA controller
  - 16 channels
  - compatible: brcm,bcm2835-dma
  - driver: `CONFIG_DMA_BCM2835`
- BCM2835 Thermal Sensor
  - compatible: brcm,bcm283[5-7]-thermal
  - driver: `CONFIG_BCM2835_THERMAL` (disabled on RPi4)
- BCM2835 SPI0 controller
  - compatible: brcm,bcm283[5-7]-spi or brcm,bcm2711-spi
  - driver: `CONFIG_SPI_BCM2835`
- BCM2835 auxiliary peripheral (UART, SPI1/2) clock
  - input: CPRMAN `BCM2835_CLOCK_VPU`
  - output: `BCM2835_AUX_CLOCK_*`
  - compatible: brcm,bcm2835-aux
  - driver: `CONFIG_CLK_BCM2835`
- BCM2835 auxiliar UART controller
  - input: `BCM2835_AUX_CLOCK_UART`
  - compatible: brcm,bcm2835-aux-uart
  - driver: `CONFIG_SERIAL_8250_BCM2835AUX`
- BCM2835 auxiliar SPI1/2 controller
  - input: `BCM2835_AUX_CLOCK_SPI[1-2]`
  - compatible: brcm,bcm2835-aux-spi
  - driver: `CONFIG_SPI_BCM2835AUX`
- BCM2835 I2S/PCM module
  - input: `BCM2835_CLOCK_PCM`
  - compatible: brcm,bcm2835-i2s
  - driver: `CONFIG_SND_BCM2835_SOC_I2S`
- BCM2835 Random number generator
  - compatible: brcm,bcm2835-rng
  - driver: `CONFIG_HW_RANDOM_BCM2835`
- BCM2835 PWM controller
  - input: `BCM2835_CLOCK_PWM`
  - compatible: brcm,bcm2835-pwm
  - driver: `CONFIG_PWM_BCM2835`
- BCM2835 GPIO controller
  - a combined GPIO controller, GPIO interrupt controller, and a
    pinmux/control device
  - input: `BCM2835_CLOCK_PWM`
  - compatible: brcm,bcm2835-gpio or brcm,bcm2711-gpio
  - driver: `CONFIG_PINCTRL_BCM2835`
- IPROC SDHCI controller
  - compatible: brcm,bcm2835-sdhci or brcm,bcm2711-emmc2
  - driver: `CONFIG_MMC_SDHCI_IPROC`
- BCM2835 VideoCore mailbox IPC
  - compatible: brcm,bcm2835-mbox
  - driver: `CONFIG_BCM2835_MBOX`
- BCM2835 Top-Level ("ARMCTRL") Interrupt Controller
  - up to 72 interrupt sources
  - compatible: brcm,bcm283[5-6]-armctrl-ic
  - driver: `CONFIG_ARCH_BCM2835`
- BCM2836 per-CPU interrupt controller
  - per-cpu interrupt controller for timer, PMU, IPIs
  - compatible: brcm,bcm2836-l1-intc
  - driver: `CONFIG_ARCH_BCM2835`
- BCM2835 I2C Controller
  - compatible: brcm,bcm2835-i2c or brcm,bcm2711-i2c
  - driver: `CONFIG_I2C_BCM2835`
- BCM2835 VideoCore DPI Controller
  - input: `BCM2835_CLOCK_{VPU,DPI}`
  - compatible: brcm,bcm2835-dpi
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore DSI Controller
  - input: `BCM2835_PLLD_DSI1` and `BCM2835_CLOCK_DSI1[EP]`
  - compatible: brcm,bcm2835-dsi[0-1]
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore HDMI Controller
  - input: `BCM2835_PLLH_PIX` and `BCM2835_CLOCK_HSM`
  - compatible: brcm,bcm2835-hdmi
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore Hardware Video Scaler
  - compatible: brcm,bcm2835-hvs or brcm,bcm2711-hvs
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore PixelValve
  - compatible: brcm,bcm2835-pixelvalve[0-2] or brcm,bcm2711-pixelvalve[0-4]
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore TXP (writeback) Controller
  - compatible: brcm,bcm2835-txp
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore V3D GPU
  - compatible: brcm,bcm2835-v3d
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore VEC
  - compatible: brcm,bcm2835-vec
  - driver: `CONFIG_DRM_VC4`
- BCM2835 VideoCore IV
  - combined all (DPI, DSI, HDMI, HVS, PixelValve, TXP, V3D, VEC) above
  - compatible: brcm,bcm2835-vc4 or brcm,bcm2711-vc5
  - driver: `CONFIG_DRM_VC4`

## BCM2711 DT

- BCM2711 HDMI DVP
  - compatible: brcm,brcm2711-dvp
  - driver: `CONFIG_CLK_BCM2711_DVP`
- BCM2711 HDMI Controller
  - compatible: brcm,bcm2711-hdmi[0-1]
  - driver: `CONFIG_DRM_VC4`
- STB PCIe Host Controller
  - compatible: brcm,bcm2711-pcie
  - driver: `CONFIG_PCIE_BRCMSTB`
- STB IIC Master Controller
  - compatible: brcm,bcm2711-hdmi-i2c
  - driver: `CONFIG_I2C_BRCMSTB`
- BCM7xxx Ethernet Controller (GENET)
  - compatible: brcm,bcm2711-genet-v5
  - driver: `CONFIG_BCMGENET`
- IPROC HWRNG controller
  - compatible: brcm,bcm2711-rng200
  - driver: `CONFIG_HW_RANDOM_IPROC_RNG200`
- AVS ring oscillator thermal
  - compatible: `brcm,bcm2711-avs-monitor`
  - compatible: `brcm,bcm2711-thermal`
  - driver: `CONFIG_BCM2711_THERMAL`

## Raspberry Pi DT

- Broadcom BCM2711/BCM2835 Platform
  - compatible: raspberrypi,4-model-b, raspberrypi,3-model-b-plus, ...
- Raspberry Pi VideoCore firmware driver
  - compatible: raspberrypi,bcm2835-firmware
  - compatible: raspberrypi,firmware-clocks
  - compatible: raspberrypi,firmware-reset
  - driver: `CONFIG_RASPBERRYPI_FIRMWARE`
  - driver: `CONFIG_CLK_RASPBERRYPI`
  - driver: `CONFIG_RESET_RASPBERRYPI`
- RPi power domain driver
  - output: `RPI_POWER_DOMAIN_*`
  - compatible: `raspberrypi,bcm2835-power`
  - driver: `CONFIG_RASPBERRYPI_POWER`
- Raspberry Pi GPIO expander
  - compatible: raspberrypi,firmware-gpio
  - driver: `CONFIG_GPIO_RASPBERRYPI_EXP`

## Dumped DT on downstream kernel

- compatible: `raspberrypi,4-model-b`
- `reserved-memory`
  - `linux,cma`
    - compatible: `shared-dma-pool`
    - driver: `CONFIG_DMA_CMA`
- `clocks`
  - `clk-osc` and `clk-usb`
    - compatible: `fixed-clock`
    - driver: `CONFIG_COMMON_CLK`
- `memory`
- `gpu`
  - compatible: `brcm,bcm2711-vc5`
  - driver: `CONFIG_DRM_VC4`
- `arm-pmu`
  - compatible: `arm,cortex-a72-pmu`
  - driver: `CONFIG_HW_PERF_EVENTS`
- `scb`
  - compatible: `simple-bus`
  - `dma`
    - compatible: `brcm,bcm2711-dma`
  - `ethernet`
    - compatible: `brcm,bcm2711-genet-v5`
    - driver: `CONFIG_BCMGENET`
  - `vp9-decoder`
    - compatible: `raspberrypi,rpivid-vp9-decoder`
  - `hevc-decoder`
    - compatible: `raspberrypi,rpivid-hevc-decoder`
  - `pcie`
    - compatible: `brcm,bcm2711-pcie`
    - driver: `CONFIG_PCIE_BRCMSTB`
  - `rpivid-local-intc`
    - compatible: `raspberrypi,rpivid-local-intc`
  - `h264-decoder`
    - compatible: `raspberrypi,rpivid-h264-decoder`
  - `xhci`
    - compatible: `generic-xhci`
    - status: `disabled`
    - driver: `CONFIG_USB_XHCI_PLATFORM`
- `sd_vcc_reg`, `fixedregulator_3v3`, and `fixedregulator_5v0`
  - compatible: `regulator-fixed`
  - driver: `CONFIG_REGULATOR_FIXED_VOLTAGE`
- `leds`
  - compatible: `gpio-leds`
  - driver: `CONFIG_LEDS_GPIO`
- `chosen`
  - bootargs
  - linux,initrd-start
  - linux,initrd-end
  - etc
- `timer`
  - compatible: `arm,armv8-timer`
  - driver: `CONFIG_ARM_ARCH_TIMER`
- `clk-108M`
  - compatible: `fixed-clock`
  - driver: `CONFIG_COMMON_CLK`
- `v3dbus`
  - compatible: `brcm,2711-v3d`
  - driver: `CONFIG_DRM_V3D` (downstream only)
- `phy`
  - compatible: `usb-nop-xceiv`
  - driver: `CONFIG_NOP_USB_XCEIV`
- `emmc2bus`
  - compatible: `simple-bus`
  - `emmc2`
    - compatible: `brcm,bcm2711-emmc2`
    - driver: `CONFIG_MMC_SDHCI_IPROC`
- `sd_io_1v8_reg`
  - compatible: `regulator-gpio`
  - driver: `CONFIG_REGULATOR_GPIO`
- `soc`
  - compatible: `simple-bus`
  - serial * 6
  - pixelvalve * 4
  - cprman
  - csi * 2
  - spi * 5
  - hvs
  - gpio
  - mmc * 2
  - i2c * 7
  - vcsm
  - pwm * 2
  - clock
  - timer
  - i2s
  - hdmi
  - mailbox * 2
  - gpiomem
  - vec
  - power
  - firmware
  - dsi * 2
  - mmcnr
  - fb
  - local_intc
  - dpi
  - i2c0mux
  - watchdog
  - aux
  - axiperf
  - sound
  - txp
  - dma
  - interrupt-controller
  - firmwarekms
  - rng
  - usb
  - smi
  - avs-monitor

## SoC

- three main processors with 3 different instruction sets
  - a VPU, dual-core dual-issue 16-way SIMD for system managements, codecs, etc.
  - QPUs, for 3D works
  - an ARM CPU, to run applications

## Boot Process on RPi4

- When powered on, VPU executes stage1 bootloader on SoC ROM
  - it initializes eMMC controller
  - it executes stage2 from recovery.bin on sdcard, or from EEPROM
  - CPU is reset and SDRAM is disabled
- VPU executes stage2 bootloader (normally on EEPROM)
  - it initializes more of the system, including SDRAM
  - config is written to EEPROM as well
  - it loads stage3 from `startup4.elf` on sdcard or usb to SDRAM
- VPU executes stage3 bootloader (`starup4.elf`) on SDRAM
  - it parses `config.txt`
  - it loads various AP (ARM CPU) images
  - ARM CPU is out of reset and starts running
  - stage3 bootloader is actually a full RTOS based on ThreadX
- ARM executes some initializations, armstub, and kernel
  - <https://github.com/raspberrypi/tools/tree/master/armstubs>
- open source firmwares
  - stage2/3 replacement, <https://github.com/christinaa/rpi-open-firmware>
    - it initializes the system similar to stage2
    - it initializes ARM to run an embedded chainloader
    - the chainloader (re-)initializes eMMC controller and loads linux kernel
    - most hw blocks do not work
  - EFI, <https://github.com/pftf/RPi4>
    - it is built from official EDK2 and backed by ARM and VMWare
    - it instructs stage3 (via `config.txt`) to use EDK2 as armstub
    - it can chainload any EFI bootloader (grub2, systemd-boot,
      linux kernel itself)

## PXE

- update EEPROM and `BOOT_ORDER`
  - <https://github.com/raspberrypi/rpi-eeprom>
  - extrat config from fw file (or eeprom)
  - edit `BOOT_ORDER`
  - apply confi to fw file (or eeprom)
  - flash
- it looks for "Raspberry Pi Boot" PXE boot option
- these files are fetched
  - <https://github.com/raspberrypi/firmware>
  - config.txt
  - start4.elf
  - fixup4.dat
  - bcm2711-rpi-4-b.dtb
  - overlays/overlay_map.dtb
  - cmdline.txt
  - kernel7l.img

## Devices

- lsusb
  - one 5G/s root hub driven by `xhci_hcd/4p`
  - one 480M/s root hub driven by `xhci_hcd/1p`
- lspci
  - one Broadcom pci bridge driven by `pcieport`
  - one VIA VL805 usb 3.0 controller driven by `xhci_hcd`
- 6 uarts
  - <https://www.raspberrypi.org/documentation/configuration/uart.md>
  - uart 0 is `/dev/ttyAMA0` driven by `amba-pl011`
  - uart 1 is `/dev/ttyS0`
  - uart [2-5] is disabled by default
- one BT/WIFI controller
  - the WIFI part is driven by `brcmfmac`
  - add `dtparam=krnbt=on` to `config.txt` to enable the BT part in DT and
    allow `btbcm` to drive it
  - otherwise, use `btattach` in userspace to attach `/dev/ttyAMA0`
- one GPU
  - managed by propriertary driver by default
  - add `dtoverlay=vc4-kms-v3d-pi4` to `config.txt` to enable the device in DT
    and allow `vc4` and `v3d` to drive it
  - `vc4` drives the display part
  - `v3d` drives the 3D part
- one audio device
  - driven by `snd_bcm2835`

## More Devices

- `amba` bus
  - `fe201000.serial` driven by `uart-pl011`
- `cec` bus
  - HDMI consumer electronics control
  - `cec[0-1]`
- `clockevents` bus
  - `clockevent[0-3]`
  - `broadcast`
- `clocksource` bus
  - `clocksource0`
- `cpu` bus
  - `cpu[0-3]`
- `event_source` bus
  - `armv7_cortex_a15`
  - `kprobe`
  - `tracepoint`
  - etc
- `gpio` bus
  - `gpiochip[0-1]`
- `i2c` bus
  - `i2c-[11-12]`
- `mdio_bus` bus
  - `unimac-mdio`
- `media` bus
  - `media[0-1]`
- `mmc` bus
  - `mmc[0-1]:*`
- `nvmem` bus
- `pci` bus
  - one driven by `pcieport`
  - another driven by `xhci_hcd`
- `pci_express` bus
  - one driven by `pcie_pme` for power management
  - another driven by `aer` for advanced error reporting
- `platform` bus
  - `3e2fd000.framebuffer` driven by `simple-framebuffer`
  - `arm-pmu` driven by `armv7-pmu`
  - `bcm2835-camera`
  - `bcm2835-power` driven by `bcm2835-power`
  - `bcm2835-wdt` driven by `bcm2835-wdt`
  - `cpufreq-dt` driven by `cpufreq-dt`
  - `fd500000.pcie` driven by `brcm-pcie`
  - `fd580000.ethernet` driven by `bcmgenet`
  - `fd5d2000.avs-monitor:thermal` driven by `bcm2711_thermal`
  - `fe003000.timer`
  - `fe004000.txp` driven by `vc4_txp`
  - `fe007000.dma` and `fe007b00.dma` driven by `bcm2835-dma`
  - `fe00b880.mailbox` driven by `bcm2835-mbox`
  - `fe100000.watchdog` driven by `bcm2835-pm`
  - `fe101000.cprman` driven by `bcm2835-clk`
  - `fe104000.rng` driven by `iproc-rng200`
  - `fe200000.gpio` driven by `pinctrl-bcm2835`
  - `fe200000.gpiomem` driven by `gpiomem-bcm2835`
  - `fe215000.aux` driven by `bcm2835-aux-clk`
  - `fe300000.mmcnr` driven by `mmc-bcm2835`
  - `fe340000.emmc2` driven by `sdhci-iproc`
  - `fe400000.hvs` driven by `vc4_hvs`
  - `feb00000.hevc-decoder`, `feb10000.rpivid-local-intc`,
    `feb20000.h264-decoder`, and `feb30000.vp9-decoder` driven by `rpivid-mem`
  - `fec00000.v3d` driven by `v3d`
  - `fe206000.pixelvalve`, `fe207000.pixelvalve`, `fe20a000.pixelvalve`,
    `fe216000.pixelvalve` and `fec12000.pixelvalve` driven by `vc4_crtc`
  - `fef00000.clock` driven by `brcm2711-dvp`
  - `fef00700.hdmi` and `fef05700.hdmi` driven by `vc4_hdmi`
  - `fef04500.i2c` and `fef09500.i2c` driven by `brcmstb-i2c`
  - `ff800000.local_intc`
  - `fixedregulator_3v3`, `fixedregulator_5v0`, and `sd_vcc_reg` driven by
    `reg-fixed-voltage`
  - `gpu` driven by `vc4-drm`
  - `kgdboc` driven by `kgdboc`
  - `leds` driven by `leds-gpio`
  - `phy`
  - `raspberrypi-cpufreq` driven by `raspberrypi-cpufreq`
  - `reg-dummy` driven by `reg-dummy`
  - `regulatory.0`
  - `sd_io_1v8_reg` driven by `gpio-regulator`
  - `snd-soc-dummy` driven by `snd-soc-dummy`
  - `timer`
  - `unimac-mdio.-19` driven by `unimac-mdio`
- `platform` bus (talk to VC firmware)
  - `bcm2835-codec` driven by `bcm2835-codec`
  - `bcm2835-isp` driven by `bcm2835-isp`
  - `fe00b840.mailbox` driven by `bcm2835_vchiq`
  - `raspberrypi-hwmon` driven by `raspberrypi-hwmon`
  - `soc:firmware` driven by `raspberrypi-firmware`
  - `soc:firmware:clocks` driven by `raspberrypi-clk`
  - `soc:firmware:gpio` driven by `raspberrypi-exp-gpio`
  - `soc:power` driven by `raspberrypi-power`
  - `soc:vcsm` driven by `bcm2835-vcsm`
  - `vcsm-cma` driven by `vcsm-cma`
- `sdio` bus
  - `mmc1:0001:[1-3]` driven by `brcmfmac`
- `serial` bus
  - `serial0-0` driven by `hci_uart_bcm`
- `usb` bus
  - some devices driven by `hub` or `usb`

## Partitioning

- partitioning
  - fdisk and `g` to use GPT
    - need to update to the latest eeprom
  - partition 1: 260M, ESP
  - partition 2: `32*1000-260`M, Linux
- filesystems
  - partition 1: `mkfs.fat -F32`
  - partition 2: `mkfs.btrfs`
- prepare btrfs
  - mount partition 2
  - `mkdir roots homes`
  - `btrfs subvolume create roots/current`
  - `btrfs subvolume create homes/current`
  - `btrfs subvolume set-default roots/current`
  - umount
- btrfs
  - mount partition 2 again with `subvol=roots/current`
  - `mkdir boot home`
  - mount partition 1 to boot
  - mount partition 2 to home with `subvol=homes/current`
