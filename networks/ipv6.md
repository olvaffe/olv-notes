IPv6
====

## Addresses

- an IPv6 address has 128 bits and is represented by
  `1111:2222:3333:4444:aaaa:bbbb:cccc:dddd`
  - eight groups of four hexadecimal digits
  - each group representing 16 bit
  - groups are separated by colons
- unicast and anycast address format
  - the first 64 bits are network prefix used for routing
    - it can be further divided into routing prefix and subnet id
    - a larger routing prefix means a smaller subnet
  - the last 64 bits are interface identifier
    - it can be autogenerated from MAC addr
    - or from DHCPv6 or assigned manully like in IPv4
  - unique local addresses are private networks similar to `192.168.0.0/24` in
    IPv4
    - they use fc00::/7: fc00::/8 is not defiend and only fd00::/8 is used
- multicast address format
  - 8-bit prefix which is always `ff`
  - 4-bit flag
  - 4-bit scope
  - 112-bit group id
- canonical text format
  - recommended to be in lower cases
  - leading zeros in each group are suppressed, but each group must retain at
    least 1 digit
    - e.g., `1:0:0:0:1:0:0:1`
  - then the longest consecutive all-zero groups are replaced by two colons
    - e.g., `1::1:0:0:1`
    - if there are two such sequences of the same size, the leftmost one is
      compressed
- special addresses
  - `::/0`: default route
  - `::/128`: unspecified address
  - `::1/128`: loopback address
  - `::ffff:0:0/96`: IPv4 mapped
  - `::ffff:0:0:0/96`: IPv4 translated
  - `64:ff9b::/96`: global IPv4/IPv6 translation
  - `64:ff9b:1::/96`: private IPv4/IPv6 translation
  - `100::/64`: discard prefix
  - `2001:0000::/32`: Teredo tunneling
  - `2001:20::/28`: ORCHIDv2
  - `2001:db8::/32`: used in docs as examples
  - `2002::/16`: 6to4 scheme (deprecated)
  - `fc00::/7`: unique local addresses
  - `fe80::/64` from `fe80::/10`: link local address
  - `ff00::/8`: multicast
- my eth0 has 3 IPv6 addresses (and 1 IPv4 address)
  - one is in `fe80::/64` and is link local
  - the other two are in the same `/64` network
    - one is `temporary`
    - one is `mngtmpaddr`
- `man ip-address`
  - `scope global` is globally valid
  - `scope link` is link local
  - `scope host` is valid in the host
  - `scope host` is valid in the host
  - `noprefixroute` does not automatically create a route for the network of the address
  - `dynamic`/`permanent` means the address is from stateless configuration or
    not
  - `mngtmpaddr` uses the address as a template for temporary addresses
  - `temporary` uses a randomly generated interface id, for better privacy
- to see only the primary IPv6 addresses,
  - `ip -6 address show dev eth0 primary`

## internal network

- called ULA (unique local address)
  - `fc00::/7`
  - similar to `192.168.0.0/16`
- let's use `fddd:59c2:214b::/48` for the router
  - `ip addr add fddd:59c2:214b::1/48 dev eth0`
- how do machines in the network get their addresses?
  - `radvd`

## 6to4

- suppose we have an IPv4 address, how do we connect to IPv6 network?
- suppose we have an IPv4 address, how do we listen to an IPv6 address?

## DHCPv6

- ISPs usually use DHCPv6 to configure home routers
- handshake
  - the client (home router) uses its link-local address and udp port 546
  - the server (usually a relay) listens on the link-local multicast address
    `ff02::1:2` and udp port 547
  - the client sends a `SOLICIT` meesage to the multicast address
    - it includes configuration options
  - server(s) replies a `ADVERTISE` meesage(s)
    - it includes requested information (prefix delecation, nameserver, etc.)
  - the client sends a `REQUEST` meesage to the multicast address
    - this message identifies the server that the client prefers
  - the server replies a `REPLY` meesage
- the client has the information it requests
  - gateway: usually a link-local address
  - prefix delegation: a network that the client can use
    - IPS router will route all traffic sent to the network to the client
- with the information at hand, the client (home router) can 
  - use SLAAC to configure its address
    - or, if an address is assigned by DHCPv6, use that address
  - use Router Advertisement to configure its clients (home devices)
    - similar to DHCPv6, the info includes the network prefix and the gateway
      (another link-local address of the home router)
    - home devices use SLAAC to configure themselves
    - the home router can also use DHCPv6 if it chooses to
- in this setup, the client and its clients usually use globally unique
  addresses
