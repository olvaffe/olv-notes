OBS Studio
==========

## Build

- <https://github.com/obsproject/obs-studio/wiki/build-instructions-for-linux>
  - `git clone --recursive https://github.com/obsproject/obs-studio.git`
  - install dependencies
  - `cmake -S . -B out -G Ninja -DLINUX_PORTABLE=ON \
           -DENABLE_AJA=OFF -DENABLE_BROWSER=OFF \
           -DENABLE_NATIVE_NVENC=OFF -DENABLE_PIPEWIRE=OFF -DENABLE_WEBRTC=OFF \
           -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache`
  - `ninja -C out`
  - `ninja -C out install`
  - `cd out/install/bin/64bit`
  - `./obs`
- top-level options
  - `-DENABLE_UI=ON` enables ui
  - `-DENABLE_SCRIPTING=ON` enables scripting
  - `-DENABLE_HEVC=ON` enables hevc encoder
  - `-DLINUX_PORTABLE=OFF` disables portable packaging
  - `-DENABLE_PULSEAUDIO=ON` enables pulseaudio support
  - `-DENABLE_WAYLAND=ON` enables wayland support
- plugin options
  - `-DENABLE_PLUGINS=ON` enables plugins
  - `-DENABLE_AJA=ON` enables AJA hw support
  - `-DENABLE_DECKLINK=ON` enables DeckLink hw support
  - `-DENABLE_ALSA=ON` enables ALSA support
  - `-DENABLE_JACK=OFF` disables JACK support
  - `-DENABLE_PIPEWIRE=ON` enables pipewire support
  - `-DENABLE_V4L2=ON` enables V4L2 support
  - `-DENABLE_UDEV=ON` enables udev support for V4L2
  - `-DENABLE_BROWSER=ON` enables browser support
  - `-DENABLE_FFMPEG_LOGGING=OFF` disables logging for ffmpeg
  - `-DENABLE_NEW_MPEGTS_OUTPUT=ON` enables native SRT/RIST mpegts output for ffmpeg
  - `-DENABLE_NATIVE_NVENC=ON` enables nvenc support
  - `-DENABLE_FFMPEG_MUX_DEBUG=OFF` disables mux debug for ffmpeg
  - `-DENABLE_LIBFDK=OFF` disables FDK AAC support
  - `-DENABLE_VST=ON` enables VST plugin support
  - `-DENABLE_WEBRTC=ON` enables webrtc output support
  - `-DENABLE_WEBSOCKET=ON` enables websocket output support
  - `-DENABLE_OSS=ON` enables OSS audio support
  - `-DENABLE_SERVICE_UPDATES=ON` enables rtmp service update support
  - `-DENABLE_SNDIO=OFF` disables sndio audio support
  - `-DENABLE_FREETYPE=ON` enables freetype text support
  - `-DENABLE_VLC=ON` enables vlc support

## Recording

- initialization
  - `main`
  - `run_program`
  - `OBSApp::OBSInit`
  - `OBSBasic::OBSInit`
  - `OBSBasic::ResetVideo`
    - `AttemptToResetVideo`
    - `obs_reset_video`
    - `obs_init_video` starts the graphics thread to run `obs_graphics_thread`
  - `OBSBasic::ResetOutputs`
    - `CreateAdvancedOutputHandler`
      - `outputHandler` is initialized to `CreateAdvancedOutputHandler`
    - `AdvancedOutput::AdvancedOutput`
    - `obs_output_create`
      - `ffmpegOutput` is false and `fileOutput` is initialized to
        `obs_output_create("ffmpeg_muxer", ...)`
  - `OBSBasic::Load`
    - `OBSBasic::LoadData`
    - `obs_load_sources`
    - `obs_load_source`
    - `obs_load_source_type`
    - `obs_source_create_set_last_ver`
    - `obs_source_create_internal`
    - `v4l2_create`
    - `v4l2_update`
    - `v4l2_init` starts the v4l2 thread to run `v4l2_thread`
- the v4l2 thread
  - `v4l2_thread` keeps capturing new frames
  - `obs_source_output_video`
  - `obs_source_output_video_internal` adds frames to `source->async_frames`
- the graphics thread
  - `obs_graphics_thread`
  - `obs_graphics_thread_loop`
  - `tick_sources`
    - `obs_source_video_tick`
    - `async_tick` sets `cur_async_frame` to the closest frame
    - `get_closest_frame`
    - `ready_async_frame`
  - `output_frames`
    - `output_frame`
    - `render_video`
      - `render_main_texture`
        - `obs_view_render`
        - `obs_source_video_render`
        - `render_video`
        - `obs_source_main_render`
        - `source_render`
        - ...
        - `obs_source_update_async_video`
          - `obs_source_get_frame` returns `source->cur_async_frame`
        - `obs_source_render_async_video`
          - `obs_source_draw_texture` draws
      - `output_gpu_encoders` if recording
        - `encode_gpu`
        - `queue_frame` moves a frame from `gpu_encoder_avail_queue` to
          `gpu_encoder_queue` and posts to `gpu_encode_semaphore`
  - `render_displays`
    - `render_display`
    - `gs_present`
    - `device_present`
    - `gl_wayland_egl_device_present`
    - `eglSwapBuffers`
- when `Start Recording` is clicked,
  - with <https://github.com/obsproject/obs-studio/pull/10137>
  - `OBSBasic::on_recordButton_clicked`
  - `OBSBasic::StartRecording`
  - `AdvancedOutput::StartRecording`
  - `obs_output_start`
  - `obs_output_actual_start`
  - `ffmpeg_mux_start`
  - `ffmpeg_mux_start_internal`
  - `obs_output_initialize_encoders`
    - `initialize_video_encoders`
    - `obs_encoder_initialize`
    - `obs_encoder_initialize_internal`
    - `h264_vaapi_create_tex`
    - `vaapi_create_tex_internal`
  - `obs_output_begin_data_capture`
    - `hook_data_capture`
    - `start_video_encoders`
    - `obs_encoder_start`
    - `obs_encoder_start_internal`
    - `add_connection`
    - `start_gpu_encode`
      - `init_gpu_encoding` creates textures and starts gpu encode thread
        to run `gpu_encode_thread`
- the gpu encode thread
  - `gpu_encode_thread` wakes up and pops a frame from `gpu_encoder_queue`
  - `vaapi_encode_tex`
    - `vaapi_create_surface` creates a va surface, exports the dmabuf, and
      calls `gs_texture_create_from_dmabuf` to import it as egl image
      - `gs_texture_create_from_dmabuf`
      - `device_texture_create_from_dmabuf`
      - `gl_wayland_egl_device_texture_create_from_dmabuf`
    - `gs_copy_texture` copies from the src tex to the egl image
      - `device_copy_texture`
      - `device_copy_texture_region`
      - `gl_copy_texture` calls `glCopyImageSubData`
    - `gs_flush`
      - `device_flush` calls `glFlush`
    - `vaapi_encode_internal` encodes the va surface
