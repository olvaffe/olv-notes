systemd special
===============

## Bootup

- `man bootup`
- `systemctl start default.target`
  - this is the default on boot, unless overriden by `systemd.unit=`
  - `systemctl set-default <unit>.target` sets the default unit
    - it is `graphical.target` by default
    - the other choice is `multi-user.target`
- `systemctl start <poweroff|reboot>.target`
  - this powers off or reboots the machine
  - fwiw, `halt.target` halts the system, making it safe to cut the power but
    does not cut the power
- `systemctl list-dependencies graphical.target`, focusing on target units
  - `graphical.target`, `Requires=multi-user.target`
    - `multi-user.target`, `Requires=basic.target`
      - `basic.target`, `Requires=sysinit.target`, `Wants=sockets.target timers.target paths.target slices.target`
        - `paths.target`
        - `slices.target`
        - `sockets.target`
        - `sysinit.target`, `Wants=local-fs.target swap.target`
          - `cryptsetup.target`, meson symlink in `sysinit.target.wants/`
          - `integritysetup.target`, meson symlink in `sysinit.target.wants/`
          - `local-fs.target`
          - `swap.target`
          - `veritysetup.target`, meson symlink in `sysinit.target.wants/`
        - `timers.target`
      - `getty.target`, meson symlink in `multi-user.target.wants/`
      - `machines.target`, `WantedBy=multi-user.target`
      - `remote-fs.target`, `WantedBy=multi-user.target`
- `systemctl list-dependencies graphical.target`, focusing on service units
  - `graphical.target`
    - `display-manager.service`
      - e.g., `gdm.service` has `Alias=display-manager.service` to create the
        symlink
      - some distros remove the line and manage the symlink in their package
        managers instead
    - `multi-user.target`
      - most services
      - `basic.target`
        - `sysinit.target`
          - boot-related services
- `systemctl list-dependencies poweroff.target`
  - `poweroff.target`, `Requires=systemd-poweroff.service`
    - `systemd-poweroff.service`, `Requires=shutdown.target umount.target final.target`
      - `shutdown.target`
      - `umount.target`
      - `final.target`
  - how this works is
    - all service units by default has `Conflicts=shutdown.target`, causing
      them to be stopped
    - all mount units by default has `Conflicts=umount.target`, causing them
      to be umounted
    - `final.target` does not appear to be used

## Built-in Units

- systemd comes with a lot of built-in units
  - they are under `units/` in the source tree
- `presets/90-systemd.preset` specifies preset
  - on first boot, `manager_preset_all` applies `UNIT_FILE_PRESET_ENABLE_ONLY`
    automatically
  - these targets are enabled
    - `machines.target`, `WantedBy=multi-user.target`
    - `reboot.target`, `Alias=ctrl-alt-del.target`
    - `remote-cryptsetup.target`, `WantedBy=multi-user.target`
    - `remote-fs.target`, `WantedBy=multi-user.target`
- `units/meson.build` also creates symlinks for the built-in units
  - `cryptsetup.target` under `sysinit.target.wants/`
  - `dev-hugepages.mount` under `sysinit.target.wants/`
  - `dev-mqueue.mount` under `sysinit.target.wants/`
  - `getty.target` under `multi-user.target.wants/`
  - `getty@.service.in` as `autovt@.service`
  - `graphical.target` as `default.target`
  - `systemd-battery-check.service.in` under `initrd.target.wants/`
  - `systemd-bsod.service.in` under `initrd.target.wants/`
  - `integritysetup.target` under `sysinit.target.wants/`
  - `kmod-static-nodes.service.in` under `sysinit.target.wants/`
  - `ldconfig.service` under `sysinit.target.wants/`
  - `proc-sys-fs-binfmt_misc.automount` under `sysinit.target.wants/`
  - `reboot.target` as `ctrl-alt-del.target`
  - `remote-cryptsetup.target` under `initrd-root-device.target.wants/`
  - `remote-integritysetup.target` under `initrd-root-device.target.wants/`
  - `remote-veritysetup.target` under `initrd-root-device.target.wants/`
  - `sys-fs-fuse-connections.mount` under `sysinit.target.wants/`
  - `sys-kernel-config.mount` under `sysinit.target.wants/`
  - `sys-kernel-debug.mount` under `sysinit.target.wants/`
  - `sys-kernel-tracing.mount` under `sysinit.target.wants/`
  - `systemd-ask-password.socket` under `sockets.target.wants/`
  - `systemd-ask-password-console.path` under `sysinit.target.wants/`
  - `systemd-ask-password-wall.path` under `multi-user.target.wants/`
  - `systemd-binfmt.service.in` under `sysinit.target.wants/`
  - `systemd-boot-random-seed.service` under `sysinit.target.wants/`
  - `systemd-bootctl.socket` under `sockets.target.wants/`
  - `systemd-confext-initrd.service` under `initrd.target.wants/`
  - `systemd-coredump.socket` under `sockets.target.wants/`
  - `systemd-creds.socket` under `sockets.target.wants/`
  - `systemd-factory-reset.socket` under `sockets.target.wants/`
  - `systemd-factory-reset-request.service.in` under `factory-reset.target.wants/`
  - `systemd-firstboot.service` under `sysinit.target.wants/`
  - `systemd-hibernate-clear.service.in` under `sysinit.target.wants/`
  - `systemd-hostnamed.service.in` as `dbus-org.freedesktop.hostname1.service`
  - `systemd-hostnamed.socket` under `sockets.target.wants/`
  - `systemd-hwdb-update.service.in` under `sysinit.target.wants/`
  - `systemd-importd.service.in` as `dbus-org.freedesktop.import1.service`
  - `systemd-importd.socket` under `sockets.target.wants/`
  - `imports.target` under `sysinit.target.wants/`
  - `systemd-initctl.socket` under `sockets.target.wants/`
  - `systemd-journal-catalog-update.service` under `sysinit.target.wants/`
  - `systemd-journal-flush.service` under `sysinit.target.wants/`
  - `systemd-journald-dev-log.socket` under `sockets.target.wants/`
  - `systemd-journald.service.in` under `sysinit.target.wants/`
  - `systemd-journald.socket` under `sockets.target.wants/`
  - `systemd-localed.service.in` as `dbus-org.freedesktop.locale1.service`
  - `systemd-logind.service.in` under `multi-user.target.wants/`
  - `systemd-logind.service.in` as `dbus-org.freedesktop.login1.service`
  - `systemd-machine-id-commit.service` under `sysinit.target.wants/`
  - `systemd-machined.service.in` as `dbus-org.freedesktop.machine1.service`
  - `systemd-machined.socket` under `sockets.target.wants/`
  - `systemd-modules-load.service.in` under `sysinit.target.wants/`
  - `systemd-pcrextend.socket` under `sockets.target.wants/`
  - `systemd-pcrmachine.service.in` under `sysinit.target.wants/`
  - `systemd-pcrphase-factory-reset.service.in` under `factory-reset.target.wants/`
  - `systemd-pcrphase-initrd.service.in` under `initrd.target.wants/`
  - `systemd-pcrphase-sysinit.service.in` under `sysinit.target.wants/`
  - `systemd-pcrphase-storage-target-mode.service.in` under `storage-target-mode.target.wants/`
  - `systemd-pcrphase.service.in` under `sysinit.target.wants/`
  - `systemd-tpm2-setup.service.in` under `sysinit.target.wants/`
  - `systemd-tpm2-setup-early.service.in` under `sysinit.target.wants/`
  - `systemd-pcrlock.socket` under `sockets.target.wants/`
  - `systemd-portabled.service.in` as `dbus-org.freedesktop.portable1.service`
  - `systemd-random-seed.service.in` under `sysinit.target.wants/`
  - `systemd-repart.service` under `sysinit.target.wants/`
  - `systemd-repart.service` under `initrd-root-fs.target.wants/`
  - `systemd-sysctl.service.in` under `sysinit.target.wants/`
  - `systemd-sysext-initrd.service` under `initrd.target.wants/`
  - `systemd-sysext.socket` under `sockets.target.wants/`
  - `systemd-sysupdated.service.in` as `dbus-org.freedesktop.sysupdate1.service`
  - `systemd-sysusers.service` under `sysinit.target.wants/`
  - `systemd-timedated.service.in` as `dbus-org.freedesktop.timedate1.service`
  - `systemd-tmpfiles-clean.timer` under `timers.target.wants/`
  - `systemd-tmpfiles-setup-dev-early.service` under `sysinit.target.wants/`
  - `systemd-tmpfiles-setup-dev.service` under `sysinit.target.wants/`
  - `systemd-tmpfiles-setup.service` under `sysinit.target.wants/`
  - `systemd-udev-trigger.service` under `sysinit.target.wants/`
  - `systemd-udevd-control.socket` under `sockets.target.wants/`
  - `systemd-udevd-kernel.socket` under `sockets.target.wants/`
  - `systemd-udevd-varlink.socket` under `sockets.target.wants/`
  - `systemd-udevd.service.in` under `sysinit.target.wants/`
  - `systemd-update-done.service.in` under `sysinit.target.wants/`
  - `systemd-update-utmp-runlevel.service.in` under `multi-user.target.wants/`
  - `systemd-update-utmp-runlevel.service.in` under `graphical.target.wants/`
  - `systemd-update-utmp-runlevel.service.in` under `rescue.target.wants/`
  - `systemd-update-utmp.service.in` under `sysinit.target.wants/`
  - `systemd-user-sessions.service.in` under `multi-user.target.wants/`
  - `tmp.mount` under `local-fs.target.wants/`
  - `var-lib-machines.mount` under `remote-fs.target.wants/`
  - `var-lib-machines.mount` under `machines.target.wants/`
  - `veritysetup.target` under `sysinit.target.wants/`

## Special Units

- `man systemd.special`
- active and passive target units
  - they are optional and must be pulled in by their producers (passive) or
    consumers (active)
  - `network-online.target` is an active target unit
    - producers have `WantedBy=network-online.target` and `Before=network-online.target`
    - consumers have `Wants=network-online.target` and `After=network-online.target`
    - when a consumer is enabled, it wants producers and is blocked by
      producers
  - `network.target` is a passive target unit
    - producers have `Wants=network.target` and `Before=network.target`
    - consumers have `After=network.target`
    - when a producer is enabled, it blocks consumers
      - otherwise consumers proceed without the producer
- targets
  - `basic.target`
  - `bluetooth.target`
  - `cryptsetup-pre.target`
  - `veritysetup.target`
  - `ctrl-alt-del.target`
  - `boot-complete.target`
  - `default.target`
  - `emergency.target`
  - `exit.target`
  - `factory-reset.target`
  - `factory-reset-now.target`
  - `final.target`
  - `getty.target`
  - `graphical.target`
  - `halt.target`
  - `hibernate.target`
  - `hybrid-sleep.target`
  - `suspend-then-hibernate.target`
  - `initrd.target`
  - `initrd-fs.target`
  - `initrd-root-device.target`
  - `initrd-root-fs.target`
  - `initrd-usr-fs.target`
  - `integritysetup-pre.target`
  - `integritysetup.target`
  - `kbrequest.target`
  - `kexec.target`
  - `local-fs.target`
  - `machines.target`
  - `multi-user.target`
  - `network-online.target`
  - `paths.target`
  - `poweroff.target`
  - `printer.target`
  - `reboot.target`
  - `remote-cryptsetup.target`
  - `remote-integritysetup.target`
  - `remote-veritysetup.target`
  - `remote-fs.target`
  - `rescue.target`
  - `runlevel2.target`
  - `runlevel3.target`
  - `runlevel4.target`
  - `runlevel5.target`
  - `shutdown.target`
  - `sigpwr.target`
  - `sleep.target`
  - `slices.target`
  - `smartcard.target`
  - `sockets.target`
  - `soft-reboot.target`
  - `sound.target`
  - `storage-target-mode.target`
  - `suspend.target`
  - `swap.target`
  - `sysinit.target`
  - `system-update.target`
  - `system-update-pre.target`
  - `timers.target`
  - `tpm2.target`
  - `umount.target`
  - `usb-gadget.target`
- special passive target units
  - `blockdev@.target`
  - `cryptsetup.target`
  - `veritysetup-pre.target`
  - `first-boot-complete.target`
    - e.g., `systemd-firstboot.service` pulls it in
    - consumers can have `After=first-boot-complete.target`
  - `getty-pre.target`
  - `local-fs-pre.target`
  - `network.target`
    - e.g., `systemd-networkd.service` pulls it in
    - consumers can have `After=network.target`
  - `network-pre.target`
  - `nss-lookup.target`
    - e.g., `systemd-resolved.service` pulls it in
    - consumers can have `After=nss-lookup.target`
  - `nss-user-lookup.target`
  - `remote-fs-pre.target`
  - `rpcbind.target`
  - `ssh-access.target`
  - `time-set.target`
    - e.g., `systemd-timesyncd.service` pulls it in
    - consumers can have `After=time-set.target`
  - `time-sync.target`
    - e.g., `systemd-time-wait-sync.service` pulls it in
    - consumers can have `After=time-sync.target`
- special slice units
  - `-.slice`
  - `machine.slice`
  - `capsule.slice`
  - `system.slice`
  - `user.slice`
- rest
  - `-.mount`
  - `dbus.service`
  - `dbus.socket`
  - `display-manager.service`
    - e.g., `gdm.service` has `Alias=display-manager.service`
  - `init.scope`
  - `syslog.socket`
  - `system-update-cleanup.service`
