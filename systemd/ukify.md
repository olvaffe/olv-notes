ukify
=====

## Unified Kernel Image (UKI)

- <https://uapi-group.org/specifications/specs/unified_kernel_image/>
- UKI Components
  - a boot stub that is a uefi app that parses the rest of the sections
  - `.linux` is the kernel
  - `.osrel` is optional human-readable os info from `/etc/os-release`
  - `.cmdline` is optional cmdline
  - `.initrd` is optional initrd
  - `.ucode` is optional initrd for microcode
  - `.splash` is optional image displayed before booting the kernel
  - `.dtb` is optional dtb
  - `.dtbauto` is zero or more dtbs
  - `.hwids` is optional hwid table generated from SMBIOS by `fwupdtool hwids`
  - `.uname` is optional kernel version generated by `uname -r`
  - `.sbat` is optional revocation list
  - `.pcrsig` is optional signed pcr 11 values
  - `.pcrpkey` is optional public key used by `.pcrsig`

## Setup

- `cp /usr/lib/kernel/uki.conf /etc/kernel` and edit
- `ukify genkey --config /etc/kernel/uki.conf` to generate privkey and cert
- `/usr/lib/systemd/systemd-sbsign sign ...` to sign the bootloader
- `bootctl install --secure-boot-auto-enroll yes ..` to install signed
  bootloader and stage keys for enrollment
  - THE KEYS MAY BRICK THE MACHINE ESPECIALLY ON THINKPAD ONCE ENROLLED
  - `man loader.conf` has examples to generate working keys
- `echo "secure-boot-enroll manual" >> /boot/loader/loader.conf` to enroll
  keys on next boot
