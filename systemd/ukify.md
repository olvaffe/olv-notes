ukify
=====

## Unified Kernel Image (UKI)

- <https://uapi-group.org/specifications/specs/unified_kernel_image/>
- UKI Components
  - a boot stub that is a uefi app that parses the rest of the sections
  - `.linux` is the kernel
  - `.osrel` is optional human-readable os info from `/etc/os-release`
  - `.cmdline` is optional cmdline
  - `.initrd` is optional initrd
  - `.ucode` is optional initrd for microcode
  - `.splash` is optional image displayed before booting the kernel
  - `.dtb` is optional dtb
  - `.dtbauto` is zero or more dtbs
  - `.hwids` is optional hwid table generated from SMBIOS by `fwupdtool hwids`
  - `.uname` is optional kernel version generated by `uname -r`
  - `.sbat` is optional revocation list
  - `.pcrsig` is optional signed pcr 11 values
  - `.pcrpkey` is optional public key used by `.pcrsig`

## Setup

- `cp /usr/lib/kernel/uki.conf /etc/kernel` and edit
- `ukify genkey --config /etc/kernel/uki.conf` to generate privkey and cert
- `/usr/lib/systemd/systemd-sbsign sign ...` to sign the bootloader
- `bootctl install --secure-boot-auto-enroll yes ..` to install signed
  bootloader and stage keys for enrollment
  - THE KEYS MAY BRICK THE MACHINE ESPECIALLY ON THINKPAD ONCE ENROLLED
  - `man loader.conf` has examples to generate working keys
- `echo "secure-boot-enroll manual" >> /boot/loader/loader.conf` to enroll
  keys on next boot

## Internals

- `ukify genkey --pcr-private-key test-priv.pem --pcr-public-key test-public.pem`
  - `generate_priv_pub_key_pair` generates an rsa key pair
  - the key pair is written to the specified files
- `ukify build --pcr-private-key test-priv.pem --pcr-public-key test-public.pem --linux test-vmlinuz --initrd test-initrd --cmdline root=/dev/sda2`
  - systemd-stub (`/usr/lib/systemd/boot/efi/linuxx64.efi.stub`) is the base
  - `/etc/os-release` is embedded in `.osrel` section
  - `--cmdline` embeds the kernel cmdline in `.cmdline` section
  - `--pcr-public-key` embeds the pubkey in `.pcrpkey` section
  - `--linux` embeds the kernel image (with efi stub) in `.linux` section
    - uname is parsed out of the image and is embedded in `.uname` section
  - `--initrd` embeds the initrd image in `.initrd` section
  - `STUB_SBAT` is embedded in `.sbat` section
  - `call_systemd_measure`
    - `systemd-measure` pre-calculates pcr11 values based on pe sections and
      boot phases
      - by default, the boot phases are
        - `enter-initrd` for initrd
        - `nter-initrd:leave-initrd` for early boot
        - `enter-initrd:leave-initrd:sysinit` for later boot
        - `enter-initrd:leave-initrd:sysinit:ready` for post boot
    - `--pcr-private-key` signs pre-calculated pcr11 values and embeds the
      signatures in `.pcrsig` section
