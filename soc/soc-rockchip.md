Rockchip SoCs
=============

## Products

- RK18 series
  - RK1808, A35 x2 @1.6GHz
- RK30 series
  - RK3036, A7 x2 @1.0GHz
- RK31 series
  - RK3126, A7 x4 @1.2GHz
  - RK3128, A7 x4 @1.2GHz
  - RK3188, A9 x4 @1.6GHz
- RK32 series
  - RK3288, A17 x4 @1.8GHz
  - RK3289, A7 x4 @1.5GHz
- RK33 series
  - RK3308, A35 x4 @1.3GHz
  - RK3326, A35 x4 @1.5GHz
  - RK3328, A53 x4
  - RK3368, A53 x8 @1.5GHz
  - RK3399, A72 x2 @1.8GHz + A53 x4 @1.4GHz
  - RK3399Pro, A72 x2 @1.8GHz + A53 x4 @1.4GHz
- RK35 series
  - RK3566, A55 x4
  - RK3568, A55 x4 @2.0GHz
  - RK3568J, A55 x4
  - RK3582, A76 x2 + A55 x4, no GPU
  - RK3588, A76 x4 + A55 x4
- RK Power series
  - PX2, A9 x2 @1.4GHz
  - PX3, A9 x4 @1.6GHz
  - PX30, A35 x4
  - PX5, A53 x8 @1.5GHz

## NanoPI R5S Boot Sequence

- <https://wiki.pine64.org/wiki/RK3399_boot_sequence>
  - BootRom (BROM)
    - after reset, cpu0 executes bootrom stored in the read-only memory
    - bootrom tries to load the bootloader from, in order,
      - nor or nand flash on spi1
        - it issues 0x9f (Read Identification)
        - it uses 0x03 (nor) or 0x13 (nand) to read blocks
        - it looks for for the bootloader magic number in the first 32 bytes
      - emmc
        - it looks for the bootloader magic number at sector 0x40
      - sd on sdmmc
        - same as emmc after sdmmc controller initialization
      - over usb by putting the OTG0 usb controller in device mode (id
        `2207:330c`)
        - the board usually has a maskrom button, which forces all prior
          methods to fail and forces bootrom to enter this mode
    - the bootloader consists of up to 3 parts
      - id block, which is the header
      - first stage, which is loaded to and executed from sram
        - it's main job is to initialize dram
      - optional second stage, which is loaded to and executed from low dram
        - it's main job is to chainload another bootloader
        - the first stage can choose to do both jobs without returning to
          bootram
      - if over usb, the host sends the first stage using request 0x0471 and the
        second stage using request 0x0472
  - U-Boot as the bootloader
    - it consists of 4 parts
      - TPL, which is loaded by bootrom to sram
        - it initializes dram, and returns to bootrom
      - SPL, which is loaded by bootrom to low dram
        - it loads respective parts of TF-A (ARM Trusted Firmware-A) BL31
          firmware to dram, sram, and pmu sram
        - it also loads u-boot proper to dram
      - TF-A BL31
        - it sets up EL2 to run u-boot proper
        - it stays resident until system shutdown
      - U-Boot proper
- <https://opensource.rock-chips.com/wiki_Rockusb>
  - bootrom has a minimal rockusb implementation
    - it only supports `rkdeveloptool db` (`DownloadBoot`), which tells
      bootrom to run the specified bootloader
  - the proprietary bootloader (`rkxx_loader_vx.xx.bin`) has two rockusb
    implementations
    - it consits of `ddr.bin`, `usbplug.bin`, and `miniloader.bin`
    - after `rkdeveloptool db rkxx_loader_vx.xx.bin`, the device will run
      `ddr.bin` to initialize dram and run `usbplug.bin` to enter rockusb mode
    - `miniloader.bin` has another rockusb implementation that is entered when
      - the recovery key or the volume up key is pressed, or
      - it cannot find the next bootloader at sector 0x4000
  - u-boot provides anothe rockusb implementation
    - `rockusb 0 mmc 0` to enter
- <https://opensource.rock-chips.com/wiki_Boot_option>
  - make sure bootrom is in rockusb/maskrom mode
  - `rkdeveloptool db rkxx_loader_vx.xx.bin` to initialize dram (`ddr.bin`)
    and enter another rockusb mode (`usbplug.bin`)
  - `rkdeveloptool wl 0x40 idbloader.img` to write `idbloader.img` to sector
    0x40
    - it consists of the idblock header, `u-boot-tpl.bin`, and
      `spl/u-boot-spl.bin`
    - or, if proprietary, `rkdeveloptool ul rkxx_loader_vx.xx.bin`
      - it writes `ddr.bin` and `miniloader.bin` to sector 0x40
  - `rkdeveloptool wl 0x4000 u-boot.itb` to write `u-boot.itb` to sector
    0x4000
    - it consists of `u-boot-nodtb.bin` (u-boot proper), `bl31.elf` (tf-a
      bl31), and `u-boot.dtb` (device tree)
  - `rkdeveloptool wl 0x8000 boot.img` to write `boot.img` to sector 0x8000
    - it consists of another bootloader (grub2) or the kernel
      image/dtb/initramfs
  - `rkdeveloptool wl 0x40000 rootfs.img` to write `rootfs.img` to sector
    0x40000
    - it is the root fs

## NanoPI R5C Debian

- <https://github.com/inindev/nanopi-r5>
  - `dtb/make_dtb.sh`
    - it downloads `linux-6.5.6.tar.xz` and extracts
      - `include/dt-bindings`
      - `include/uapi`
      - `arch/arm64/boot/dts/rockchip`
    - it applies `patches`
    - it uses `dtc` to generate `rk3568-nanopi-{r5c,r5s}.dtb`
  - `uboot/make_uboot.sh`
    - it clones <https://github.com/u-boot/u-boot.git> and checks out
      `v2023.10`
    - `cherry_pick` cherry-picks a bunch of upstream fixes
    - it applies `patches`
    - it builds u-boot twice, for r5c and r5s
      - `make nanopi-${model}-rk3568_defconfig`
      - `make BL31="$atf_file" ROCKCHIP_TPL="$tpl_file"`
        - the firmwares are from <https://github.com/rockchip-linux/rkbin>
        - this builds `idbloader.img` and `u-boot.itb`
  - `debian/nanopi-r5c/make_debian_img.sh`
    - it downloads
      - <https://mirrors.edge.kernel.org/pub/linux/kernel/firmware/linux-firmware-20230210.tar.xz>
      - <https://github.com/inindev/nanopi-r5/releases/download/v12.0.1/idbloader-r5c.img>
      - <https://github.com/inindev/nanopi-r5/releases/download/v12.0.1/u-boot-r5c.itb>
      - <https://github.com/inindev/nanopi-r5/releases/download/v12.0.1/rk3568-nanopi-r5c.dtb>
    - `parition_media` creates a single partition starting at sector 0x8000
    - `format_media` formats the partition to ext4
    - `mount_media` moutns the partition
    - it populates the partition with
      - `/etc/kernel-img.conf`
      - `/etc/fstab`
      - `/etc/kernel/postinst.d/dtb_cp`
        - it symlinks `/boot/rk3568-nanopi-r5c.dtb-${version}` to
          `/boot/rk3568-nanopi-r5c.dtb`
      - `/etc/kernel/postrm.d/dtb_rm`
        - it removes `/boot/rk3568-nanopi-r5c.dtb-${version}`
      - `/boot/mk_extlinux`
        - it updates `/boot/extlinux/extlinux.conf` when kernel is updated
          - `fdt /boot/rk3568-nanopi-r5c.dtb-${kver}`
          - `append root=... ro rootwait`
      - `/etc/kernel/postinst.d/update_extlinux`
      - `/etc/kernel/postrm.d/update_extlinux`
    - it adds to the partition these downloaded files
      - `/usr/lib/firmware/{rockchip,rtl_bt,rtl_nic,rtlwifi,rtw88,rtw89}`
      - `/boot/rk3568-nanopi-r5c.dtb`
    - it debootstraps with these packages
      - `linux-image-arm64, dbus, dhcpcd, libpam-systemd, openssh-server, systemd-timesyncd`
      - `rfkill, wireless-regdb, wpasupplicant`
      - `curl, pciutils, sudo, unzip, wget, xxd, xz-utils, zip, zstd`
    - it modifies/adds these files
      - `/etc/apt/sources.list`
      - `/etc/default/locale`
      - `/etc/wpa_supplicant/wpa_supplicant.conf`
      - `/usr/lib/dhcpcd/dhcpcd-hooks/10-wpa_supplicant`
      - `/etc/skel/.bashrc`
      - `/root/.bashrc`
      - `/etc/hostname`
      - `/etc/hosts`
    - it adds user `debian` and adds `/etc/sudoers.d/debian`
    - it adds `/etc/rc.local` for first-boot init and changes some files
      - the script generates `/etc/machine-id`, reconfigures ssh, resizes
        rootfs partition, changes partition uuid, generates macs, etc.
      - the script removes itself when done
    - it dds `idbloader-r5c.img` to sector 0x40 and dds `u-boot-r5c.itb` to
      0x4000
      - sector size is 512 bytes

## Orange Pi 5

- <https://github.com/orangepi-xunlong/orangepi-build>
  - it appears to be based on armbian
  - `scripts/main.sh`
    - `BOARD` is `orangepi5`
    - sources `external/config/boards/orangepi5.conf`
      - `BOARDFAMILY` is `rockchip-rk3588`
      - `BOOT_SCENARIO` is `spl-blobs`
      - `BOOT_SUPPORT_SPI` is `yes`
    - sources `scripts/configuration.sh`
      - sources `external/config/sources/families/rockchip-rk3588.conf`
        - sources `external/config/sources/families/include/rockchip64_common.inc`
          - `DDR_BLOB` is `rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin`
            - from <https://github.com/armbian/rkbin>
          - `BL31_BLOB` is `rk35/rk3588_bl31_v1.45_20240422.elf`
            - from <https://github.com/orangepi-xunlong/rk-rootfs-build/tree/rkbin/rk35>
            - it is prebuilt of <https://github.com/ARM-software/arm-trusted-firmware>
        - `KERNELSOURCE` is <https://github.com/orangepi-xunlong/linux-orangepi.git>
        - `KERNELBRANCH` is `orange-pi-6.1-rk35xx`
        - `LINUXCONFIG` is `linux-rockchip-rk3588-current`
        - `BOOTSOURCE` is <https://github.com/orangepi-xunlong/u-boot-orangepi.git>
        - `BOOTBRANCH` is `v2017.09-rk3588`
        - `BOOTCONFIG` is `orangepi_5_defconfig`
        - `IMAGE_PARTITION_TABLE` is `gpt`
        - `OFFSET` is `30`
        - `BOOTFS_TYPE` is `fat`
        - `ROOTFS_TYPE` is `ext4`
    - `compile_uboot` builds uboot
    - `compile_kernel` builds kernel
- frankstein image
  - image layout
    - LBA 0..33: GPT
    - LBA 64..16383: `idbloader.img`
    - LBA 16384..32767: `u-boot.itb`
    - LBA 32768..: free
  - `fallocate -l 256M a.img`
  - `echo -e 'label:gpt\nfirst-lba:34\nstart=64,size=16320\nstart=16384,size=16384\nstart=32768' | sfdisk a.img`
    - the third partition should be ESP for uboot to consider it bootable
  - `dd if=src.img of=a.img bs=512 skip=64 seek=64 count=16320 conv=notrunc`
  - `dd if=src.img of=a.img bs=512 skip=16384 seek=16384 count=16384 conv=notrunc`
  - `losetup -fP && mkfs.vfat /dev/loop0p3 && losetup -D`
    - populate `/extlinux/extlinux.conf`, kernel, rootfs, etc.
- serial
  - `minicom -D /dev/ttyUSB0 -b 1500000`
- u-boot log from latest rkbin/u-boot/atf
  - `rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin` packed in `idbloader.img`
    - from `DDR 9fffbe1e78 cym 24/02/04-10:09:20,fwver: v1.16`
    - to `change to F0: 2112MHz`
  - `u-boot-spl.bin` packed in `idbloader.img`
    - from `U-Boot SPL 2024.10-rc6 (Oct 01 2024 - 17:05:11 -0700)`
    - to `## Checking hash(es) for Image atf-2 ... sha256+ OK`
  - `bl31.elf` packed in `u-boot.itb`
    - from `NOTICE:  BL31: v2.11.0(release):v2.11.0-702-gbccc22756`
    - to `NOTICE:  BL31: Built : 16:46:29, Oct  1 2024`
  - u-boot packed in `u-boot.itb`
    - from `U-Boot 2024.10-rc6 (Oct 01 2024 - 17:05:11 -0700)`
    - to `Starting kernel ...`
    - `Hit any key to stop autoboot:  0`
      - autoboot executes `bootcmd`, which is `bootflow scan -lb`
- u-boot `printenv`
  - `include/env_default.h`
    - `baudrate=1500000`, from `CONFIG_BAUDRATE`
    - `bootcmd=bootflow scan -lb`, from `CONFIG_BOOTCOMMAND`
    - `bootdelay=2`, from `CONFIG_BOOTDELAY`
    - `loadaddr=0xc00800`, from `CONFIG_SYS_LOAD_ADDR`
  - `include/configs/rk3588_common.h`
    - `boot_targets=mmc1 mmc0 nvme scsi usb pxe dhcp spi`, from `BOOT_TARGETS`
    - `fdt_addr_r=0x12000000`
    - `fdtfile=rockchip/rk3588s-orangepi-5.dtb`, from
      `CONFIG_DEFAULT_FDT_FILE`
    - `fdtoverlay_addr_r=0x12100000`
    - `kernel_addr_r=0x02000000`
    - `kernel_comp_addr_r=0x0a000000`
    - `kernel_comp_size=0x8000000`
    - `partitions=...`, from `PARTS_DEFAULT`
      - `uuid_disk=${uuid_gpt_disk};`
      - `name=loader1,start=32K,size=4000K,uuid=${uuid_gpt_loader1};`
      - `name=loader2,start=8MB,size=4MB,uuid=${uuid_gpt_loader2};`
      - `name=trust,size=4M,uuid=${uuid_gpt_atf};`
      - `name=boot,size=112M,bootable,uuid=${uuid_gpt_boot};`
      - `name=rootfs,size=-,uuid=B921B045-1DF0-41C3-AF44-4C6F280D3FAE;`
    - `pxefile_addr_r=0x00e00000`
    - `ramdisk_addr_r=0x12180000`
    - `script_offset_f=0xffe000`
    - `script_size_f=0x2000`
    - `scriptaddr=0x00c00000`
- kernel log
  - `Booting Linux on physical CPU 0x0000000000 [0x412fd050]`
  - `Linux version 6.1.43-rockchip-rk3588 ...`
  - `Kernel command line: console=ttyS1,1500000 console=tty0 debug root=/dev/mmcblk1p3 rootwait...`
- maskrom
  - press the maskrom key and power on the board
    - the bootrom boots into the maskrom instead of the normal flow
  - <https://github.com/rockchip-linux/rkdeveloptool.git>
    - `autoreconf -i && ./configure && make` to build `rkdeveloptool`
  - <https://github.com/rockchip-linux/rkbin>
    - `./tools/boot_merger RKBOOT/RK3588MINIALL.ini` to generate
      `rk3588_spl_loader_v1.16.113.bin`
  - `./rkdeveloptool db rk3588_spl_loader_v1.16.113.bin` tells the bootrom to
    boot the specified miniloader
  - `./rkdeveloptool ef` tells the miniloader to erase the spi flash
    - the normal flow will find the stage1 from emmc rather than from spi
- uart in downstream kernel
  - `rk3588s.dtsi` defines `uart[0-9]`
    - they differ in `reg`, `interrupts`, `clocks`, `dmas`, and `pinctrl-0`
  - `rk3588s-orangepi-5.dtsi`
    - it enables `uart9` and changes `pinctrl-0` from `<&uart9m1_xfer>` to
      `<&uart9m2_xfer &uart9m2_ctsn>`
  - `rk3588s-orangepi-5.dts`
    - it keeps `uart{0,1,3,4}` disabled and changes `pinctrl-0` from
      - `<&uart0m1_xfer>` to `<&uart0m2_xfer>`
      - `<&uart1m1_xfer>` to `<&uart1m1_xfer>`
      - `<&uart3m1_xfer>` to `<&uart3m0_xfer>`
      - `<&uart4m1_xfer>` to `<&uart4m0_xfer>`
  - `rk3588-linux.dtsi`
    - it adds an `fiq-debugger` node with `<&uart2m0_xfer>`
  - `overlay/rk3588-uart2-m0.dts`
    - it disables `fiq-debugger` and enables `uart2` with `<&uart2m0_xfer>`
    - `/dev/ttyFIQ0` becomes `/dev/ttyS2` after applying
      `fdtoverlays /dtb/rockchip/overlay/rk3588-uart2-m0.dtbo`

## RK3588 Mali

- <https://github.com/armbian/linux-rockchip/tree/rk-6.1-rkr4.1>
  - rkr4.1 is rockchip sdk 4.1
  - mali ddk is `g25p0-00eac0`, which seems to be based on `r50p0-00eac0`
- <https://github.com/JeffyCN/mirrors/tree/libmali>
  - mali ddk is `g24p0-4`

## RK3588S Datasheet and Devicetree

- eMMC
  - `sdhci: mmc@fe2e0000`
  - `dwcmshc_probe` probes the controller
- SD/MMC
  - `sdmmc: mmc@fe2c0000`
  - `dw_mci_rockchip_probe` probes the controller
- Flexible Serial Flash Interface(FSPI)
  - `sfc: spi@fe2b0000`
  - `rk3588s-orangepi-5.dts` adds a child node compatible with `jedec,spi-nor`
  - `rockchip_sfc_probe` probes the controller
    - `spi_register_controller` registers an `spi_controller`
    - `of_register_spi_devices` registers all child nodes as `spi_device`s
  - `spi_nor_probe` probes the child node
- CRU, clock and reset unit
  - the datasheet says
    - Support total 18 PLLs to generate all clocks
    - One oscillator with 24MHz clock input
    - Support global soft-reset control for whole chip, also individual
      soft-reset for each component
  - `cru: clock-controller@fd7c0000`
  - `rk3588_clk_init` inits the clocks
    - there are 3 `rockchip_cpuclk_reg_data` (3 cpu clusters?)
      - `rk3588_cpub0clk_data` for 2 big cores
      - `rk3588_cpub1clk_data` for the other 2 big cores
      - `rk3588_cpulclk_data` for the 4 little cores
    - `rk3588_clk_branches` is a big table
      - fixed, top, bigcore0, bigcore1, dsu, audio, bus, center isp1, npu,
      - nvm, php, rga, vdec, sdio, usb, vdpu, venc, vi, vo0, vo1, pmu, more?
      - gpu has
        - `CLK_GPU_SRC`, downstream of `gpll_cpll_aupll_npll_spll_p`
        - `CLK_GPU_PVTM` and `CLK_CORE_GPU_PVTM`, downstrem of `CLK_GPU_SRC`
        - `CLK_GPU`, `CLK_GPU_COREGROUP`, and `CLK_GPU_STACKS`
          - downstream of `CLK_GPU_SRC`
          - panthor enables all 3 clocks
  - `rk3588_rst_init` inits the soft reset controls
    - `rockchip,rk3588-cru.h` lists 661 reset controls
    - some blocks rely on the reset signals from the cru
    - their drivers use `reset_control_*` to put the block into or out of
      reset
- PMU, power management unit
  - the datasheet says
    - Support 10 separate voltage domains
    - Support 45 separate power domains
  - `pmu: power-management@fd8d8000`
    - `power: power-controller`
      - the 45 pm domains form a tree
  - `include/dt-bindings/power/rk3588-power.h` lists 10 voltage domains (VD)
    and 44 pm domins
    - `VD_LITDSU` has `RK3588_PD_CPU_{0,1,2,3}`
    - `VD_BIGCORE0` has `RK3588_PD_CPU_{4,5}`
    - `VD_BIGCORE1` has `RK3588_PD_CPU_{6,7}`
    - `VD_NPU` has `RK3588_PD_{NPU,NPUTOP,NPU1,NPU2}`
    - `VD_GPU` has `RK3588_PD_GPU`
    - `VD_VCODEC` has `RK3588_PD_{VCODEC,RKVDEC0,RKVDEC1,VENC0,VENC1}`
    - `VD_DD01` has `RK3588_PD_DDR01`
    - `VD_DD23` has `RK3588_PD_DDR23`
    - `VD_LOGIC` has `RK3588_PD_{CENTER,VDPU,RGA30,AV1,VOP,VO0,VO1,VI,ISP1}`
      - and `RK3588_PD_{FEC,RGA31,USB,PHP,GMAC,PCIE,NVM,NVM0,SDIO,AUDIO}`
      - and `RK3588_PD_{SECURE,SDMMC,CRYPTO,BUS}`
    - `VD_PMU` has `RK3588_PD_PMU1`
  - `rockchip_pm_domain_probe` inits with `rk3588_pm_domains`
    - it only lists 29 domains
    - i guess the rest is controlled by other means or left at default
    - panthor uses `RK3588_PD_GPU`
- Timer
  - the datasheet says
    - Support 18 non-secure timers with 64bits counter and interrupt-based
      operation
  - `timer0: timer@feae000`
  - `rk_timer_init` probes the timer
    - `rk_clkevt_init` registers a `clock_event_device`
    - `rk_clksrc_init` registers a `clocksource`
- PWM
  - the datasheet says
    - Support 16 on-chip PWMs(PWM0~PWM15) with interrupt-based operation
  - `pwm0: pwm@fd8b0000` to `pwm15: pwm@febf0030`
  - `rockchip_pwm_probe` probes the devices
    - `pwmchip_add` registers the 16 pwms
- Watchdog
  - `wdt: watchdog@feaf0000`
  - `dw_wdt_drv_probe` probes the device
- Interrupt Controller
  - `gic: interrupt-controller@fe600000`
    - `its0: msi-controller@fe640000`
    - `its1: msi-controller@fe660000`
  - `gic_of_init` inits the controller
    - `its_init` inits the child nodes
- DMAC
  - the datasheet says
    - Totally three embedded DMA controllers for peripheral system
  - `dmac0: dma-controller@fea10000`
  - `dmac1: dma-controller@fea30000`
  - `dmac2: dma-controller@fed10000`
  - `of_platform_bus_create` adds the devices
    - they are marked `arm,primecell` and are added by `of_amba_device_create`
  - `pl330_probe` probes the controllers
- 2D Graphics Engine
  - `display_subsystem: display-subsystem`
  - `vop: vop@fdd90000`
  - `vop_mmu: iommu@fdd97e00`
  - `rockchip_drm_platform_probe` probes the pseudo display subsystem
  - `vop2_probe` probes the vop
  - `rk_iommu_probe` probes the iommu
- HDMI/eDP TX interface
  - the datasheet says
    - Support two HDMI/eDP TX combo interface
  - `hdptxphy_hdmi0: phy@fed60000`
  - armbian `rk3588-base.dtsi`
    - it adds a new node `hdmi0` for the hdmi controller
      - the controller is based on DesignWare HDMI 2.1 Quad-Pixel
        - compatible with `rockchip,rk3588-dw-hdmi-qp`
        - a new driver in drm rockchip to match the string and to support
          rockchip-specific extensions
        - a new driver in drm bridge for the unextended ip
          - it does not bind to any node but is used as a helper
      - the phy is `hdptxphy_hdmi0`
      - there is an output port, `hdmi0_out`
  - armbian `rk3588s-orangepi-5.dts`
    - `hdmi0` and `hdptxphy_hdmi0` are enabled
      - one is the controller and one is the phy
    - it adds a new node `hdmi0-con` for the hdmi connector
      - compatible with `hdmi-connector`
      - it connects to `hdmi0_out` port of the hdmi controller
  - armbian `dw_hdmi_qp_rockchip_probe` probes the controller
  - `rk_hdptx_phy_probe` probes the phy
    - `devm_phy_create` creates a phy
    - `devm_of_phy_provider_register` registers a of phy provider
  - `display_connector_probe` probes the connector
- I2S
  - the datasheet says
    - I2S0/I2S1 with 8 channels
      - supports I2S, PCM, TDM
    - I2S2/I2S3 with 2 channels
      - supports I2S, PCM
    - SPDIF0/SPDIF1
    - PDM0/PDM1
    - Digital Audio Codec
    - VAD (Voice Activity Detection)
  - `i2s0_8ch: i2s@fe470000` and `i2s1_8ch: i2s@fe480000`
  - `i2s2_2ch: i2s@fe490000` and `i2s3_2ch: i2s@fe4a0000`
  - `i2s4_8ch: i2s@fddc0000`, `i2s5_8ch: i2s@fddf0000`, and `i2s9_8ch:
    i2s@fddfc000`
    - what are these?
  - `rockchip_i2s_probe` probes 2-channel i2s devices
  - `rockchip_i2s_tdm_probe` probes 8-channel i2s devices
- SDIO
  - `sdio: mmc@fe2d0000`
  - `dw_mci_rockchip_probe` probes the controller
- GMAC
  - mac implements layer 2 and phy implements layer 1, interconnected by mii
    - gmac is an impl of mac
    - mdio is an impl of mii
  - rk3588s has `gmac1` while rk3588 has both `gmac0` and `gmac1`
  - `gmac1: ethernet@fe1c0000` has a child `mdio1: mdio`
  - `rk3588s-orangepi-5.dts` adds a child node to `mdio1`, which is a phy and
    is compatible with `ethernet-phy-ieee802.3-c22`
- USB 3.1 Gen1
  - there are controllers and there are phys
    - phy can support dr (dual-role), which allows it to act as a device or a
      host
    - in usb 2.0, it is called otg
  - `usb_host0_xhci: usb@fc000000`
    - phys are `u2phy0: usb2phy@0` and `usbdp_phy0: phy@fed80000`
  - `usb_host2_xhci: usb@fcd00000`
    - phy is `combphy2_psu: phy@fee20000`
    - this is a combo phy that supports usb 3.0, pcie, and sata
  - `dwc3_probe` probes the controllers
  - `rockchip_usb2phy_probe` probes `u2phy0`
  - `rk_udphy_probe` probes `usbdp_phy0`
  - `rockchip_combphy_probe` probes `combphy2_psu`
  - on opi 5,
    - there is a DC-only type-c connector
    - there is a USB 3.1 type-c connector
      - it connects to `usbdp_phy0` phy
      - it also connects to `usbc0: usb-typec@22` for role switch, etc.
    - there is a USB 3.0 type-a connector
      - it connects to both `combphy2_psu` and `u2phy3` phys
        - which one is used depends whether the device is 2.0 or 3.0
    - there are two USB 2.0 type-a connectors, connecting to `u2phy0` and
      `u2phy2` respectively
- USB 2.0 Host
  - `usb_host0_ehci: usb@fc800000` and `usb_host0_ohci: usb@fc840000`
    - they share `u2phy2: usb2phy@8000`
  - `usb_host1_ehci: usb@fc880000` and `usb_host1_ohci: usb@fc8c0000`
    - they share `u2phy3: usb2phy@c000`
  - `ohci_platform_probe` probes the ohci controllers
  - `ehci_platform_probe` probes the ehci controllers
  - `rockchip_usb2phy_probe` probes the phys
- Combo PIPE PHY Interface
  - `combphy0_ps: phy@fee00000`
    - used by one of `pcie2x1l2` and `sata0`
  - `combphy2_psu: phy@fee20000`
    - used by one of `usb_host2_xhci`, `pcie2x1l1` and `sata2`
  - `rk3588s-orangepi-5.dts`
    - `pcie2x1l2` is enabled instead of `sata0`
      - it connects to m2 socket, allowing pcie devices (nvme, wifi/bt, etc)
      - one can use an overlay to disable `pcie2x1l2` and enable `sata0`, to
        connect a m2 sata to the m2 socket
    - `usb_host2_xhci` is enabled instead of `pcie2x1l1` or `sata2`
      - it connects to usb 3.0 type-a
  - `rockchip_combphy_probe` probes the two phys
  - `rockchip_pcie_probe` probes the two pcie 2.1 controllers
  - `ahci_dwc_probe` probes the two sata 3.1 controllers
- SPI
  - the datasheet says
    - Support 5 SPI Controllers(SPI0-SPI4)
  - `spi0: spi@feb00000` to `spi4: spi@fecb0000`
  - `rk3588s-orangepi-5.dts` enables `spi2` and adds `pmic@0` child node
  - `rockchip_spi_probe` probes the spi controllers
    - `spi_register_controller` registers an `spi_controller`
    - `of_register_spi_devices` registers all child nodes as `spi_device`s
  - `rockchip_spi_probe` probes the spi controllers
  - `rk8xx_spi_probe` probes the pmic
- I2C Master controller
  - the datasheet says
    - Support 9 I2C Master(I2C0-I2C8)
  - `i2c0: i2c@fd880000` to `i2c8: i2c@feca0000`
  - `rk3588s-orangepi-5.dts` enables `i2c0`, `i2c2`, and `i2c6`
    - `i2c0` gets `vdd_cpu_big0_s0: regulator@42` and `vdd_cpu_big1_s0: regulator@43`
    - `i2c2` gets `vdd_npu_s0: regulator@42`
    - `i2c6` gets `usbc0: usb-typec@22` and `hym8563: rtc@51`
  - `rk3x_i2c_probe` probes the i2c controllers
  - `fan53555_regulator_probe` probes the regulators
  - `fusb302_probe` probes the typec port controller
  - `hym8563_probe` probes the rtc
- UART interface
  - the datasheet says
    - Support 10 UART interfaces(UART0-UART9)
  - `uart0: serial@fd890000` to `uart9: serial@febc0000`
  - `rk3588s-orangepi-5.dts` enables `uart2`
  - `dw8250_probe` probes the uart controllers
- GPIO
  - `pinctrl: pinctrl`
    - `gpio0: gpio@fd8a0000`
    - `gpio1: gpio@fec20000`
    - `gpio2: gpio@fec30000`
    - `gpio3: gpio@fec40000`
    - `gpio4: gpio@fec50000`
    - 5 banks, 32 pins each bank
  - `rockchip_pinctrl_probe` probes the pin controller
    - `rk3588_pin_ctrl` lists 5 banks
  - `rockchip_gpio_probe` probes the gpio banks
- TS-ADC, Temperature Sensor ADC
  - the datasheet says
    - Support to 7 channel TS-ADC
  - `tsadc: tsadc@fec00000`
  - `thermal_zones: thermal-zones`
    - `package_thermal: package-thermal` uses channel 0
    - `bigcore0_thermal: bigcore0-thermal` uses channel 1
    - `bigcore2_thermal: bigcore2-thermal` uses channel 2
    - `little_core_thermal: littlecore-thermal` uses channel 3
    - `center_thermal: center-thermal` uses channel 4 (near `PD_CENTER`)
    - `gpu_thermal: gpu-thermal` uses channel 4
    - `npu_thermal: npu-thermal` uses channel 6
  - `rk3588_tsadc_data` lists 7 channels
  - `of_thermal_zone_find` finds in the `thermal-zones` node
- SARADC, Successive approximation ADC
  - the datasheet says
    - 6 single-ended input channels
      - RK3588 has 8 channels
  - `saradc: adc@fec10000`
  - `rk3588s-orangepi-5.dts` adds an `adc-keys` node
    - it looks like the recovery button is connected to channel 1 and is
      driven by `CONFIG_KEYBOARD_ADC`
    - the schematics says
      - channel 0 for maskrom
      - channel 1 for recovery
      - channel 3 for headphone
  - `rk3588_saradc_data` lists 8 channels
- OTP
  - the datasheet says
    - Support 32Kbit space and higher 4k address space is non-secure part.
  - `otp: efuse@fecc0000`
    - `cpu_code: cpu-code@2`
    - `otp_id: id@7`
    - `cpub0_leakage: cpu-leakage@17`
    - `cpub1_leakage: cpu-leakage@18`
    - `cpul_leakage: cpu-leakage@19`
    - `log_leakage: log-leakage@1a`
    - `gpu_leakage: gpu-leakage@1b`
    - `otp_cpu_version: cpu-version@1c`
    - `npu_leakage: npu-leakage@28`
    - `codec_leakage: codec-leakage@29`
  - `rk3588_data` says the size is 0x400 and `RK3588_NO_SECURE_OFFSET` is
    0x300 (in dwords?)

## Orange Pi 5 Schematics

- SoC
  - P1, `RK3588S_Power/GND`
    - `CPU_BIG0`
    - `CPU_BIG1`
    - `CPU_LIT`
    - `GPU`
    - `NPU`
    - `LOGIC`
    - `VDENC`
  - P2, `RK3588S_OSC/PLL/PMUIO`
    - `OSC`
    - `PLL`
    - `PMUIO1`
    - `PMUIO2`
  - P3, `RK3588S DDR Controler`
  - P4, `RK3588S Flash/SD Controller`
    - `EMMCIO`
    - `VCCIO2`
  - P5, `RK3588S_USB20/USB30/DP PHY`
    - `USB 3.0 OTG of TYPEC0 /DP1.4 ALT`
    - `USB2.0 OTG of TYPEC0`
    - `USB2.0 HOST0`
    - `USB2.0 HOST1`
  - P6, `RK3588S_SARADC/1.8V GPIO`
    - `SARADC`
    - `OTP`
    - `TSADC`
    - `VCCIO1`
  - P7, `RK3588S_MIPI Interface`
    - `MIPI D/C-PHY DSI_TX Port0`
    - `MIPI D/C-PHY CSI_RX Port0`
    - `MIPI D/C-PHY DSI_TX Port1`
    - `MIPI D/C-PHY CSI_RX Port1`
    - `MIPI DPHY CSI_RX Port0`
  - P8, `RK3588S_HDMI/eDP Interface`
    - `HDMI TX/eDP1.3 MUX Port0`
  - P9, `RK3588S PCIE2/SATA3/USB3 PHY`
    - `PCIE20/SATA30 Mux0`
    - `PCIE20/SATA30/USB30 HOST Mux2`
  - P10, `RK3588S GPIO`
    - `VCCIO4`
    - `VCCIO5`
    - `VCCIO6`
- Peripherals
  - P11, `Power_Type-C`
    - `USB Type-C Port`
    - `USB Type-C CC CTRL`
    - `TPYE-C POWER IN`
    - `RTC IC`
  - P12, `Power_PMIC`
    - `BUCK1` to `BUCK10`
    - `PLDO`
    - `NLDO`
    - `VCCIO`
    - `VCCA`
  - P13, `Power_Ext Discrete`
    - `VDD_CPU_BIG0`
    - `VDD_CPU_BIG1`
    - `VDD_NPU`
  - P14, `USB20/USB30 HOST Port`
    - `USB2.0 Type-A Port`
    - `USB3.0 HOST`
  - P15, `DDR Memory`
    - `LPDDR4`
  - P16, `Flash-TF Card`
    - `MicroSD Card`
  - P17, `VI-Camera MIPI CSI0-RX / Debug`
    - `Cam1`
  - P18, `VI-Camera_MIPI-DPHY-RX`
    - `Cam2`
    - `Cam3`
  - P19, `VO-HDMI2.1 TX`
    - `HDMI2.1 TX0`
  - P20, `VO-MIPI DPHY0/1-TX`
    - `MIPI DPHY0 TX`
    - `MIPI DPHY1 TX`
  - P21, `1000M PHY ETH`
    - `YT8531C`
  - P22, `M.2_PCIe_SATA`
    - `PCIE M.2 NGFF M-KEY SOCKET`
  - P23, `Audio Codec(ES8388)`
    - `CODEC ES8388`
    - `EARPHONE`
    - `Analog MIC`
  - P24, `EXT I/O`
    - `DIP26`
  - P25, `KEY`
    - `MASKROM KEY`
    - `POWER_Key`
    - `RECOVERY`
    - `UART Debug`
    - `LED RUN`
    - `LED PWR`
  - P26, `KEY`
    - `SPI FLASH`
